<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Using Interactive Connectivity Establishment (ICE) with Session Description Protocol (SDP) offer/answer and Session Initiation Protocol (SIP)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology"/>
<link href="#rfc.section.3" rel="Chapter" title="3 ICE Candidate Exchange and Offer/Answer Mapping"/>
<link href="#rfc.section.4" rel="Chapter" title="4 SDP Offer/Answer Procedures"/>
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Initial Offer/Answer Exchange"/>
<link href="#rfc.section.4.1.1" rel="Chapter" title="4.1.1 Sending the Initial Offer"/>
<link href="#rfc.section.4.1.2" rel="Chapter" title="4.1.2 Receiving the Initial Offer"/>
<link href="#rfc.section.4.1.3" rel="Chapter" title="4.1.3 Receipt of the Initial Answer"/>
<link href="#rfc.section.4.1.4" rel="Chapter" title="4.1.4 Performing Connectivity Checks"/>
<link href="#rfc.section.4.1.5" rel="Chapter" title="4.1.5 Concluding ICE"/>
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Subsequent Offer/Answer Exchanges"/>
<link href="#rfc.section.4.2.1" rel="Chapter" title="4.2.1 Generating the Offer"/>
<link href="#rfc.section.4.2.2" rel="Chapter" title="4.2.2 Receiving the Offer and Generating an Answer"/>
<link href="#rfc.section.4.2.3" rel="Chapter" title="4.2.3 Receiving the Answer for a Subsequent Offer"/>
<link href="#rfc.section.4.2.4" rel="Chapter" title="4.2.4 Updating the Check and Valid Lists"/>
<link href="#rfc.section.5" rel="Chapter" title="5 Grammar"/>
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 &quot;candidate&quot; Attribute"/>
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 &quot;remote-candidates&quot; Attribute"/>
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 &quot;ice-lite&quot; and &quot;ice-mismatch&quot; Attributes"/>
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 &quot;ice-ufrag&quot; and &quot;ice-pwd&quot; Attributes"/>
<link href="#rfc.section.5.5" rel="Chapter" title="5.5 &quot;ice-pacing&quot; Attribute"/>
<link href="#rfc.section.5.6" rel="Chapter" title="5.6 &quot;ice-options&quot; Attribute"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Keepalives"/>
<link href="#rfc.section.7" rel="Chapter" title="7 Media Handling"/>
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Sending Media"/>
<link href="#rfc.section.7.1.1" rel="Chapter" title="7.1.1 Procedures for All Implementations"/>
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Receiving Media"/>
<link href="#rfc.section.8" rel="Chapter" title="8 Usage with SIP"/>
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 Latency Guidelines"/>
<link href="#rfc.section.8.1.1" rel="Chapter" title="8.1.1 Offer in INVITE"/>
<link href="#rfc.section.8.1.2" rel="Chapter" title="8.1.2 Offer in Response"/>
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 SIP Option Tags and Media Feature Tags"/>
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 Interactions with Forking"/>
<link href="#rfc.section.8.4" rel="Chapter" title="8.4 Interactions with Preconditions"/>
<link href="#rfc.section.8.5" rel="Chapter" title="8.5 Interactions with Third Party Call Control"/>
<link href="#rfc.section.9" rel="Chapter" title="9 Setting Ta and RTO for RTP Media Streams"/>
<link href="#rfc.section.10" rel="Chapter" title="10 Security Considerations"/>
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 Attacks on the Offer/Answer Exchanges"/>
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 Insider Attacks"/>
<link href="#rfc.section.10.2.1" rel="Chapter" title="10.2.1 The Voice Hammer Attack"/>
<link href="#rfc.section.10.2.2" rel="Chapter" title="10.2.2 Interactions with Application Layer Gateways and SIP"/>
<link href="#rfc.section.11" rel="Chapter" title="11 IANA Considerations"/>
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 SDP Attributes"/>
<link href="#rfc.section.11.1.1" rel="Chapter" title="11.1.1 candidate Attribute"/>
<link href="#rfc.section.11.1.2" rel="Chapter" title="11.1.2 remote-candidates Attribute"/>
<link href="#rfc.section.11.1.3" rel="Chapter" title="11.1.3 ice-lite Attribute"/>
<link href="#rfc.section.11.1.4" rel="Chapter" title="11.1.4 ice-mismatch Attribute"/>
<link href="#rfc.section.11.1.5" rel="Chapter" title="11.1.5 ice-pwd Attribute"/>
<link href="#rfc.section.11.1.6" rel="Chapter" title="11.1.6 ice-ufrag Attribute"/>
<link href="#rfc.section.11.1.7" rel="Chapter" title="11.1.7 ice-pacing Attribute"/>
<link href="#rfc.section.11.1.8" rel="Chapter" title="11.1.8 ice-options Attribute"/>
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 Interactive Connectivity Establishment (ICE) Options Registry"/>
<link href="#rfc.section.12" rel="Chapter" title="12 Acknowledgments"/>
<link href="#rfc.references" rel="Chapter" title="13 References"/>
<link href="#rfc.references.1" rel="Chapter" title="13.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="13.2 Informative References"/>
<link href="#rfc.appendix.A" rel="Chapter" title="A Examples"/>
<link href="#rfc.appendix.B" rel="Chapter" title="B The remote-candidates Attribute"/>
<link href="#rfc.appendix.C" rel="Chapter" title="C Why Is the Conflict Resolution Mechanism Needed?"/>
<link href="#rfc.appendix.D" rel="Chapter" title="D Why Send an Updated Offer?"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.4.8 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Petit-Huguenin, M., Keranen, A., and S. Nandakumar" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ietf-mmusic-ice-sip-sdp-11" />
  <meta name="dct.issued" scheme="ISO8601" content="2017-1-23" />
  <meta name="dct.abstract" content="This document describes how Interactive Connectivity Establishment (ICE) is used with Session Description Protocol (SDP) offer/answer and Session Initiation Protocol (SIP).  " />
  <meta name="description" content="This document describes how Interactive Connectivity Establishment (ICE) is used with Session Description Protocol (SDP) offer/answer and Session Initiation Protocol (SIP).  " />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">MMUSIC</td>
  <td class="right">M. Petit-Huguenin</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">Impedance Mismatch</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">A. Keranen</td>
</tr>
<tr>
  <td class="left">Expires: July 27, 2017</td>
  <td class="right">Ericsson</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">S. Nandakumar</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">Cisco Systems</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">January 23, 2017</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Using Interactive Connectivity Establishment (ICE) with Session Description Protocol (SDP) offer/answer and Session Initiation Protocol (SIP)<br />
  <span class="filename">draft-ietf-mmusic-ice-sip-sdp-11</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This document describes how Interactive Connectivity Establishment (ICE) is used with Session Description Protocol (SDP) offer/answer and Session Initiation Protocol (SIP).  </p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on July 27, 2017.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2017 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<p>This document may contain material from IETF Documents or IETF Contributions published or made publicly available before November 10, 2008.  The person(s) controlling the copyright in some of this material may not have granted the IETF Trust the right to allow modifications of such material outside the IETF Standards Process. Without obtaining an adequate license from the person(s) controlling the copyright in such materials, this document may not be modified outside the IETF Standards Process, and derivative works of it may not be created outside the IETF Standards Process, except to format it for publication as an RFC or to translate it into languages other than English.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>2.   <a href="#rfc.section.2">Terminology</a></li>
<li>3.   <a href="#rfc.section.3">ICE Candidate Exchange and Offer/Answer Mapping</a></li>
<li>4.   <a href="#rfc.section.4">SDP Offer/Answer Procedures</a></li>
<li>4.1.   <a href="#rfc.section.4.1">Initial Offer/Answer Exchange</a></li>
<li>4.1.1.   <a href="#rfc.section.4.1.1">Sending the Initial Offer</a></li>
<li>4.1.2.   <a href="#rfc.section.4.1.2">Receiving the Initial Offer</a></li>
<li>4.1.3.   <a href="#rfc.section.4.1.3">Receipt of the Initial Answer</a></li>
<li>4.1.4.   <a href="#rfc.section.4.1.4">Performing Connectivity Checks</a></li>
<li>4.1.5.   <a href="#rfc.section.4.1.5">Concluding ICE</a></li>
<li>4.2.   <a href="#rfc.section.4.2">Subsequent Offer/Answer Exchanges</a></li>
<li>4.2.1.   <a href="#rfc.section.4.2.1">Generating the Offer</a></li>
<li>4.2.2.   <a href="#rfc.section.4.2.2">Receiving the Offer and Generating an Answer</a></li>
<li>4.2.3.   <a href="#rfc.section.4.2.3">Receiving the Answer for a Subsequent Offer</a></li>
<li>4.2.4.   <a href="#rfc.section.4.2.4">Updating the Check and Valid Lists</a></li>
<li>5.   <a href="#rfc.section.5">Grammar</a></li>
<li>5.1.   <a href="#rfc.section.5.1">"candidate" Attribute</a></li>
<li>5.2.   <a href="#rfc.section.5.2">"remote-candidates" Attribute</a></li>
<li>5.3.   <a href="#rfc.section.5.3">"ice-lite" and "ice-mismatch" Attributes</a></li>
<li>5.4.   <a href="#rfc.section.5.4">"ice-ufrag" and "ice-pwd" Attributes</a></li>
<li>5.5.   <a href="#rfc.section.5.5">"ice-pacing" Attribute</a></li>
<li>5.6.   <a href="#rfc.section.5.6">"ice-options" Attribute</a></li>
<li>6.   <a href="#rfc.section.6">Keepalives</a></li>
<li>7.   <a href="#rfc.section.7">Media Handling</a></li>
<li>7.1.   <a href="#rfc.section.7.1">Sending Media</a></li>
<li>7.1.1.   <a href="#rfc.section.7.1.1">Procedures for All Implementations</a></li>
<li>7.2.   <a href="#rfc.section.7.2">Receiving Media</a></li>
<li>8.   <a href="#rfc.section.8">Usage with SIP</a></li>
<li>8.1.   <a href="#rfc.section.8.1">Latency Guidelines</a></li>
<li>8.1.1.   <a href="#rfc.section.8.1.1">Offer in INVITE</a></li>
<li>8.1.2.   <a href="#rfc.section.8.1.2">Offer in Response</a></li>
<li>8.2.   <a href="#rfc.section.8.2">SIP Option Tags and Media Feature Tags</a></li>
<li>8.3.   <a href="#rfc.section.8.3">Interactions with Forking</a></li>
<li>8.4.   <a href="#rfc.section.8.4">Interactions with Preconditions</a></li>
<li>8.5.   <a href="#rfc.section.8.5">Interactions with Third Party Call Control</a></li>
<li>9.   <a href="#rfc.section.9">Setting Ta and RTO for RTP Media Streams</a></li>
<li>10.   <a href="#rfc.section.10">Security Considerations</a></li>
<li>10.1.   <a href="#rfc.section.10.1">Attacks on the Offer/Answer Exchanges</a></li>
<li>10.2.   <a href="#rfc.section.10.2">Insider Attacks</a></li>
<li>10.2.1.   <a href="#rfc.section.10.2.1">The Voice Hammer Attack</a></li>
<li>10.2.2.   <a href="#rfc.section.10.2.2">Interactions with Application Layer Gateways and SIP</a></li>
<li>11.   <a href="#rfc.section.11">IANA Considerations</a></li>
<li>11.1.   <a href="#rfc.section.11.1">SDP Attributes</a></li>
<li>11.1.1.   <a href="#rfc.section.11.1.1">candidate Attribute</a></li>
<li>11.1.2.   <a href="#rfc.section.11.1.2">remote-candidates Attribute</a></li>
<li>11.1.3.   <a href="#rfc.section.11.1.3">ice-lite Attribute</a></li>
<li>11.1.4.   <a href="#rfc.section.11.1.4">ice-mismatch Attribute</a></li>
<li>11.1.5.   <a href="#rfc.section.11.1.5">ice-pwd Attribute</a></li>
<li>11.1.6.   <a href="#rfc.section.11.1.6">ice-ufrag Attribute</a></li>
<li>11.1.7.   <a href="#rfc.section.11.1.7">ice-pacing Attribute</a></li>
<li>11.1.8.   <a href="#rfc.section.11.1.8">ice-options Attribute</a></li>
<li>11.2.   <a href="#rfc.section.11.2">Interactive Connectivity Establishment (ICE) Options Registry</a></li>
<li>12.   <a href="#rfc.section.12">Acknowledgments</a></li>
<li>13.   <a href="#rfc.references">References</a></li>
<li>13.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>13.2.   <a href="#rfc.references.2">Informative References</a></li>
<li>Appendix A.   <a href="#rfc.appendix.A">Examples</a></li>
<li>Appendix B.   <a href="#rfc.appendix.B">The remote-candidates Attribute</a></li>
<li>Appendix C.   <a href="#rfc.appendix.C">Why Is the Conflict Resolution Mechanism Needed?</a></li>
<li>Appendix D.   <a href="#rfc.appendix.D">Why Send an Updated Offer?</a></li>
<li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#intro" id="intro">Introduction</a></h1>
<p id="rfc.section.1.p.1">This document describes how Interactive Connectivity Establishment (ICE) is used with Session Description Protocol (SDP) offer/answer <a href="#RFC3264">[RFC3264]</a> and Session Initiation Protocol (SIP).  The ICE specification <a href="#ICE-BIS">[ICE-BIS]</a> describes procedures that are common to all usages of ICE and this document gives the additional details needed to use ICE with SDP offer/answer and SIP.  </p>
<p id="rfc.section.1.p.2">Note that ICE is not intended for NAT traversal for SIP, which is assumed to be provided via another mechanism <a href="#RFC5626">[RFC5626]</a>.  </p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> Terminology</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.  </p>
<p id="rfc.section.2.p.2">Readers should be familiar with the terminology defined in <a href="#RFC3264">[RFC3264]</a>, in <a href="#RFC7656">[RFC7656]</a>,  in <a href="#ICE-BIS">[ICE-BIS]</a> and the following: </p>
<p/>

<dl>
  <dt>Default Destination/Candidate:</dt>
  <dd style="margin-left: 8">The default destination for a component of a media stream is the transport address that would be used by an agent that is not ICE aware.  A default candidate for a component is one whose transport address matches the default destination for that component.  For the RTP component, the default IP address is in the "c=" line of the SDP, and the port is in the "m=" line.  For the RTCP component, the address and port are indicated using the "a=rtcp" attribute defined in <a href="#RFC3605">[RFC3605]</a>, if present; otherwise, the RTCP component address is same as the address of the RTP component, and its port is one greater than the port of the RTP component.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> ICE Candidate Exchange and Offer/Answer Mapping</h1>
<p><a href="#ICE-BIS">[ICE-BIS]</a> defines ICE candidate exchange as the process for ICE agents (Initiator and Responder) to exchange their candidate information required for ICE processing at the agents.  For the purposes of this specification, the candidate exchange process corresponds to the <a href="#RFC3264">[RFC3264]</a> Offer/Answer protocol and the terminologies offerer and answerer correspond to the initiator and responder terminologies from <a href="#ICE-BIS">[ICE-BIS]</a> respectively.  </p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> SDP Offer/Answer Procedures</h1>
<h1 id="rfc.section.4.1"><a href="#rfc.section.4.1">4.1.</a> Initial Offer/Answer Exchange</h1>
<h1 id="rfc.section.4.1.1"><a href="#rfc.section.4.1.1">4.1.1.</a> Sending the Initial Offer</h1>
<p id="rfc.section.4.1.1.p.1">The offerer shall follow the procedures defined in section 4 of <a href="#ICE-BIS">[ICE-BIS]</a> to gather, prioritize and eliminate the redundant candidates.  It then chooses the default candidates and encodes them in the SDP to be sent to its peer, the answerer.  </p>
<h1 id="rfc.section.4.1.1.1"><a href="#rfc.section.4.1.1.1">4.1.1.1.</a> <a href="#sec-inuse" id="sec-inuse">Choosing Default Candidates</a></h1>
<p id="rfc.section.4.1.1.1.p.1">A candidate is said to be default if it would be the target of media from a non-ICE peer; that target is called the DEFAULT DESTINATION.  If the default candidates are not selected by the ICE algorithm when communicating with an ICE-aware peer, an updated offer/answer will be required after ICE processing completes in order to "fix up" the SDP so that the default destination for media matches the candidates selected by ICE.  If ICE happens to select the default candidates, no updated offer/answer is required.  </p>
<p id="rfc.section.4.1.1.1.p.2">An agent MUST choose a set of candidates, one for each component of each in-use media stream, to be default.  A media stream is in-use if it does not have a port of zero (which is used in RFC 3264 to reject a media stream).  Consequently, a media stream is in-use even if it is marked as a=inactive <a href="#RFC4566">[RFC4566]</a> or has a bandwidth value of zero.  </p>
<p id="rfc.section.4.1.1.1.p.3">It is RECOMMENDED that default candidates be chosen based on the likelihood of those candidates to work with the peer that is being contacted if ICE is not being used.  It is RECOMMENDED that the default candidates are the relayed candidates (if relayed candidates are available), server reflexive candidates (if server reflexive candidates are available), and finally host candidates.  </p>
<h1 id="rfc.section.4.1.1.2"><a href="#rfc.section.4.1.1.2">4.1.1.2.</a> <a href="#sec-encoding" id="sec-encoding">Encoding the SDP</a></h1>
<p id="rfc.section.4.1.1.2.p.1">The process of encoding the SDP is identical between full and lite implementations.  </p>
<p id="rfc.section.4.1.1.2.p.2">The agent will include an "m=" line for each media stream it wishes to use.  The ordering of source streams in the SDP is relevant for ICE.  ICE will perform its connectivity checks for the first "m=" line first, and consequently media will be able to flow for that stream first.  Agents SHOULD place their most important source stream, if there is one, first in the SDP.  </p>
<p id="rfc.section.4.1.1.2.p.3">There will be a candidate attribute for each candidate for a particular source stream.  <a href="#sec-grammar">Section 5</a> provides detailed rules for constructing this attribute.  </p>
<p id="rfc.section.4.1.1.2.p.4">STUN connectivity checks between agents are authenticated using the short-term credential mechanism defined for STUN <a href="#RFC5389">[RFC5389]</a>.  This mechanism relies on a username and password that are exchanged through protocol machinery between the client and server.  The username fragment and password are exchanged in the ice-ufrag and ice-pwd attributes, respectively.  </p>
<p id="rfc.section.4.1.1.2.p.5">If an agent is a lite implementation, it MUST include an "a=ice-lite" session-level attribute in its SDP to indicate this.  If an agent is a full implementation, it MUST NOT include this attribute.  </p>
<p id="rfc.section.4.1.1.2.p.6">Section 7 of <a href="#ICE-BIS">[ICE-BIS]</a> defines a new ICE option, 'ice2'.  This option is used by ICE Agents to indicate their compliancy with <a href="#ICE-BIS">[ICE-BIS]</a> specification as compared to the <a href="#RFC5245">[RFC5245]</a>.  If the Offering agent is a <a href="#ICE-BIS">[ICE-BIS]</a> compliant implementation, a session level ICE option to indicate the same (via the "a=ice-options:ice2" SDP line) MUST be included.  </p>
<p id="rfc.section.4.1.1.2.p.7">The default candidates are added to the SDP as the default destination for media.  For source streams based on RTP, this is done by placing the IP address and port of the RTP candidate into the "c=" and "m=" lines, respectively.  If the agent is utilizing RTCP and if RTCP candidate is present and is not equal to the same address and the next higher port number of the RTP candidate, the agent MUST encode the RTCP candidate using the a=rtcp attribute as defined in <a href="#RFC3605">[RFC3605]</a>.  If RTCP is not in use, the agent MUST signal that using b=RS:0 and b=RR:0 as defined in <a href="#RFC3556">[RFC3556]</a></p>
<p id="rfc.section.4.1.1.2.p.8">The transport addresses that will be the default destination for media when communicating with non-ICE peers MUST also be present as candidates in one or more a=candidate lines.  </p>
<p id="rfc.section.4.1.1.2.p.9">ICE provides for extensibility by allowing an offer or answer to contain a series of tokens that identify the ICE extensions used by that agent.  If an agent supports an ICE extension, it MUST include the token defined for that extension in the ice-options attribute.  </p>
<p id="rfc.section.4.1.1.2.p.10">The following is an example SDP message that includes ICE attributes (lines folded for readability): </p>
<pre>
v=0
o=jdoe 2890844526 2890842807 IN IP4 10.0.1.1
s=
c=IN IP4 192.0.2.3
t=0 0
a=ice-options:ice2
a=ice-pwd:asd88fgpdd777uzjYhagZg
a=ice-ufrag:8hhY
m=audio 45664 RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 UDP 2130706431 10.0.1.1 8998 typ host
a=candidate:2 1 UDP 1694498815 192.0.2.3 45664 typ srflx raddr
 10.0.1.1 rport 8998
</pre>
<p id="rfc.section.4.1.1.2.p.11">Once an agent has sent its offer or its answer, that agent MUST be prepared to receive both STUN and media packets on each candidate.  As discussed in section 9.1 of <a href="#ICE-BIS">[ICE-BIS]</a>, media packets can be sent to a candidate prior to its appearance as the default destination for media in an offer or answer.  </p>
<h1 id="rfc.section.4.1.2"><a href="#rfc.section.4.1.2">4.1.2.</a> Receiving the Initial Offer</h1>
<p id="rfc.section.4.1.2.p.1">On receiving the offer, the answerer verifies the support for ICE (section 5.1.1 of <a href="#ICE-BIS">[ICE-BIS]</a>), determines its role (section 5.1.2 of <a href="#ICE-BIS">[ICE-BIS]</a>), gathers candidates (section 4 of <a href="#ICE-BIS">[ICE-BIS]</a>), encodes the candidates in an SDP answer and sends it to its peer, the offerer.  The answerer shall then follow the steps defined in sections 5.1.3 and 5.1.4 of <a href="#ICE-BIS">[ICE-BIS]</a> to schedule the ICE connectivity checks.  </p>
<p id="rfc.section.4.1.2.p.2">The below sub-sections provide additional requirements associated with the processing of the offerer&#8217;s SDP pertaining to this specification.  </p>
<h1 id="rfc.section.4.1.2.1"><a href="#rfc.section.4.1.2.1">4.1.2.1.</a> ICE Option "ice2" considerations</h1>
<p id="rfc.section.4.1.2.1.p.1">If the SDP offer contains a session level ICE option, "ice2" , and if the answering ICE Agent is also an <a href="#ICE-BIS">[ICE-BIS]</a> compliant implementation, then the generated SDP answer MUST include the session level "a=ice-options:ice2" SDP line.  </p>
<h1 id="rfc.section.4.1.2.2"><a href="#rfc.section.4.1.2.2">4.1.2.2.</a> Choosing Default Candidates</h1>
<p id="rfc.section.4.1.2.2.p.1">The process for selecting default candidates at the answerer is identical to the process followed by the offerer, as described in <a href="#sec-inuse">Section 4.1.1.1</a> for full implementations in this specification and section 4.2 of <a href="#ICE-BIS">[ICE-BIS]</a> for lite implementations.  </p>
<h1 id="rfc.section.4.1.2.3"><a href="#rfc.section.4.1.2.3">4.1.2.3.</a> <a href="#sec-verify" id="sec-verify">Verifying ICE Support</a></h1>
<p id="rfc.section.4.1.2.3.p.1">The agent will proceed with the ICE procedures defined in <a href="#ICE-BIS">[ICE-BIS]</a> and this specification if, for each media stream in the SDP it received, the default destination for each component of that media stream appears in a candidate attribute.  For example, in the case of RTP, the IP address and port in the "c=" and "m=" lines, respectively, appear in a candidate attribute and the value in the rtcp attribute appears in a candidate attribute.  </p>
<p id="rfc.section.4.1.2.3.p.2">If this condition is not met, the agent MUST process the SDP based on normal RFC 3264 procedures, without using any of the ICE mechanisms described in the remainder of this specification with the following exceptions: </p>
<p/>

<ol>
  <li>The agent MUST follow the rules of section 8 of <a href="#ICE-BIS">[ICE-BIS]</a>, which describe keepalive procedures for all agents.  </li>
  <li>If the agent is not proceeding with ICE because there were a=candidate attributes, but none that matched the default destination of the media stream, the agent MUST include an a=ice-mismatch attribute in its answer.  </li>
  <li>If the default candidates were relayed candidates learned through a TURN server, the agent MUST create permissions in the TURN server for the IP addresses learned from its peer in the SDP it just received.  If this is not done, initial packets in the media stream from the peer may be lost.  </li>
</ol>

<p> </p>
<h1 id="rfc.section.4.1.2.4"><a href="#rfc.section.4.1.2.4">4.1.2.4.</a> Determining Role</h1>
<p id="rfc.section.4.1.2.4.p.1">In unusual cases, described in <a href="#sec-glare">Appendix C</a>, it is possible for both agents to mistakenly believe they are controlled or controlling.  To resolve this, each agent MUST select a random number, called the tie-breaker, uniformly distributed between 0 and (2**64) - 1 (that is, a 64-bit positive integer).  This number is used in connectivity checks to detect and repair this case, as described in section 6.1.2.3 of <a href="#ICE-BIS">[ICE-BIS]</a>.  </p>
<h1 id="rfc.section.4.1.3"><a href="#rfc.section.4.1.3">4.1.3.</a> Receipt of the Initial Answer</h1>
<p id="rfc.section.4.1.3.p.1">When ICE is used with SIP, forking may result in a single offer generating a multiplicity of answers.  In that case, ICE proceeds completely in parallel and independently for each answer, treating the combination of its offer and each answer as an independent offer/answer exchange, with its own set of local candidates, pairs, check lists, states, and so on.  The only case in which processing of one pair impacts another is freeing of candidates, discussed below in <a href="#sec-conclude">Section 4.1.5</a>.  </p>
<p id="rfc.section.4.1.3.p.2">On receiving the SDP answer,the offerer performs steps similar to answerer&#8217;s processing of the offer.  The offerer verifies the answerer&#8217;s ICE support determines, its role, and processes the answerer&#8217;s candidates to schedule the connectivity checks (section 6 of <a href="#ICE-BIS">[ICE-BIS]</a>).  </p>
<p id="rfc.section.4.1.3.p.3">If the offerer had included the "ice2" ICE Option in the offer and the SDP answer also includes a similar session level ICE option, then the peers are <a href="#ICE-BIS">[ICE-BIS]</a> compliant implementations.  On the other hand, if the SDP Answer lacks such a ICE option, the offerer defaults to the procedures that are backward compatible with the <a href="#RFC5245">[RFC5245]</a> specification.  </p>
<h1 id="rfc.section.4.1.3.1"><a href="#rfc.section.4.1.3.1">4.1.3.1.</a> <a href="#sec-overify" id="sec-overify">Verifying ICE Support</a></h1>
<p id="rfc.section.4.1.3.1.p.1">The logic at the offerer is identical to that of the answerer as described in section 5.1.1 of <a href="#ICE-BIS">[ICE-BIS]</a>, with the exception that an offerer would not ever generate a=ice-mismatch attributes in an SDP.  </p>
<p id="rfc.section.4.1.3.1.p.2">In some cases, the answer may omit a=candidate attributes for the media streams, and instead include an a=ice-mismatch attribute for one or more of the media streams in the SDP.  This signals to the offerer that the answerer supports ICE, but that ICE processing was not used for the session because a signaling intermediary modified the default destination for media components without modifying the corresponding candidate attributes.  See <a href="#sec-alg-sip">Section 10.2.2</a> for a discussion of cases where this can happen.  This specification provides no guidance on how an agent should proceed in such a failure case.  </p>
<h1 id="rfc.section.4.1.4"><a href="#rfc.section.4.1.4">4.1.4.</a> <a href="#sec-connectivity_check" id="sec-connectivity_check">Performing Connectivity Checks</a></h1>
<p id="rfc.section.4.1.4.p.1">The possibility for role conflicts described in section 6.1.3.1.1 of <a href="#ICE-BIS">[ICE-BIS]</a> applies to this usage and hence all full agents MUST implement the role conflict repairing mechanism.  Also both full and lite agents MUST utilize the ICE-CONTROLLED and ICE-CONTROLLING attributes as described in section 6.1.2.3 of <a href="#ICE-BIS">[ICE-BIS]</a>.  </p>
<h1 id="rfc.section.4.1.5"><a href="#rfc.section.4.1.5">4.1.5.</a> <a href="#sec-conclude" id="sec-conclude">Concluding ICE</a></h1>
<p id="rfc.section.4.1.5.p.1">Once the state of each check list is Completed, If an agent is controlling, it examines the highest-priority nominated candidate pair for each component of each media stream.  If any of those candidate pairs differ from the default candidate pairs in the most recent offer/answer exchange, the controlling agent MUST generate an updated offer as described in <a href="#sec-subsequent">Section 4.2</a>.  </p>
<p id="rfc.section.4.1.5.p.2">When ICE is used with SIP, and an offer is forked to multiple recipients, ICE proceeds in parallel and independently with each answerer, all using the same local candidates.  Once ICE processing has reached the Completed state for all peers for media streams using those candidates, the agent SHOULD wait an additional three seconds, and then it MAY cease responding to checks or generating triggered checks on that candidate. It MAY free the candidate at that time.  </p>
<p id="rfc.section.4.1.5.p.3">Freeing of server reflexive candidates is never explicit; it happens by lack of a keepalive.  The three-second delay handles cases when aggressive nomination is used, and the selected pairs can quickly change after ICE has completed.  </p>
<h1 id="rfc.section.4.2"><a href="#rfc.section.4.2">4.2.</a> <a href="#sec-subsequent" id="sec-subsequent">Subsequent Offer/Answer Exchanges</a></h1>
<p id="rfc.section.4.2.p.1">Either agent MAY generate a subsequent offer at any time allowed by <a href="#RFC3264">[RFC3264]</a>.  The rules in <a href="#sec-conclude">Section 4.1.5</a> will cause the controlling agent to send an updated offer at the conclusion of ICE processing when ICE has selected different candidate pairs from the default pairs.  This section defines rules for construction of subsequent offers and answers.  </p>
<p id="rfc.section.4.2.p.2">Should a subsequent offer fail, ICE processing continues as if the subsequent offer had never been made.  </p>
<h1 id="rfc.section.4.2.1"><a href="#rfc.section.4.2.1">4.2.1.</a> <a href="#sec-suboffer" id="sec-suboffer">Generating the Offer</a></h1>
<h1 id="rfc.section.4.2.1.1"><a href="#rfc.section.4.2.1.1">4.2.1.1.</a> Procedures for All Implementations</h1>
<h1 id="rfc.section.4.2.1.1.1"><a href="#rfc.section.4.2.1.1.1">4.2.1.1.1.</a> <a href="#sec-suboffer-restarts" id="sec-suboffer-restarts">ICE Restarts</a></h1>
<p id="rfc.section.4.2.1.1.1.p.1">An agent MAY restart ICE processing for an existing media stream as defined in section 6.3 of <a href="#ICE-BIS">[ICE-BIS]</a>.  </p>
<p id="rfc.section.4.2.1.1.1.p.2">The rules govering the ICE restart imply that setting the IP address in the "c=" line to 0.0.0.0 will cause an ICE restart.  Consequently, ICE implementations MUST NOT utilize this mechanism for call hold, and instead MUST use a=inactive and a=sendonly as described in <a href="#RFC3264">[RFC3264]</a>.  </p>
<p id="rfc.section.4.2.1.1.1.p.3">To restart ICE, an agent MUST change both the ice-pwd and the ice-ufrag for the media stream in an offer.  Note that it is permissible to use a session-level attribute in one offer, but to provide the same ice-pwd or ice-ufrag as a media-level attribute in a subsequent offer.  This is not a change in password, just a change in its representation, and does not cause an ICE restart.  </p>
<p id="rfc.section.4.2.1.1.1.p.4">An agent sets the rest of the fields in the SDP for this media stream as it would in an initial offer of this media stream (see <a href="#sec-encoding">Section 4.1.1.2</a>).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates.  </p>
<h1 id="rfc.section.4.2.1.1.2"><a href="#rfc.section.4.2.1.1.2">4.2.1.1.2.</a> Removing a Media Stream</h1>
<p id="rfc.section.4.2.1.1.2.p.1">If an agent removes a media stream by setting its port to zero, it MUST NOT include any candidate attributes for that media stream and SHOULD NOT include any other ICE-related attributes defined in <a href="#sec-grammar">Section 5</a> for that media stream.  </p>
<h1 id="rfc.section.4.2.1.1.3"><a href="#rfc.section.4.2.1.1.3">4.2.1.1.3.</a> Adding a Media Stream</h1>
<p id="rfc.section.4.2.1.1.3.p.1">If an agent wishes to add a new media stream, it sets the fields in the SDP for this media stream as if this was an initial offer for that media stream (see <a href="#sec-encoding">Section 4.1.1.2</a>).  This will cause ICE processing to begin for this media stream.  </p>
<h1 id="rfc.section.4.2.1.2"><a href="#rfc.section.4.2.1.2">4.2.1.2.</a> Procedures for Full Implementations</h1>
<p id="rfc.section.4.2.1.2.p.1">This section describes additional procedures for full implementations, covering existing media streams.  </p>
<p id="rfc.section.4.2.1.2.p.2">The username fragments, password, and implementation level MUST remain the same as used previously.  If an agent needs to change one of these, it MUST restart ICE for that media stream.  </p>
<p id="rfc.section.4.2.1.2.p.3">Additional behavior depends on the state ICE processing for that media stream.  </p>
<h1 id="rfc.section.4.2.1.2.1"><a href="#rfc.section.4.2.1.2.1">4.2.1.2.1.</a> <a href="#sec-exist-run" id="sec-exist-run">Existing Media Streams with ICE Running</a></h1>
<p id="rfc.section.4.2.1.2.1.p.1">If an agent generates an updated offer including a media stream that was previously established, and for which ICE checks are in the Running state, the agent follows the procedures defined here.  </p>
<p id="rfc.section.4.2.1.2.1.p.2">An agent MUST include candidate attributes for all local candidates it had signaled previously for that media stream.  The properties of that candidate as signaled in SDP&#8201;&#8212;&#8201;the priority, foundation, type, and related transport address&#8201;&#8212;&#8201;SHOULD remain the same.  The IP address, port, and transport protocol, which fundamentally identify that candidate, MUST remain the same (if they change, it would be a new candidate).  The component ID MUST remain the same.  The agent MAY include additional candidates it did not offer previously (see section 4.2.4.1.1), but which it has gathered since the last offer/answer exchange, including peer reflexive candidates.  </p>
<p id="rfc.section.4.2.1.2.1.p.3">The agent MAY change the default destination for media.  As with initial offers, there MUST be a set of candidate attributes in the offer matching this default destination.  </p>
<h1 id="rfc.section.4.2.1.2.2"><a href="#rfc.section.4.2.1.2.2">4.2.1.2.2.</a> <a href="#sec-exist-comp" id="sec-exist-comp">Existing Media Streams with ICE Completed</a></h1>
<p id="rfc.section.4.2.1.2.2.p.1">If an agent generates an updated offer including a media stream that was previously established, and for which ICE checks are in the Completed state, the agent follows the procedures defined here.  </p>
<p id="rfc.section.4.2.1.2.2.p.2">The default destination for media (i.e., the values of the IP addresses and ports in the "m=" and "c=" lines used for that media stream) MUST be the local candidate from the highest-priority nominated pair in the valid list for each component.  This "fixes" the default destination for media to equal the destination ICE has selected for media.  </p>
<p id="rfc.section.4.2.1.2.2.p.3">The agent MUST include candidate attributes for candidates matching the default destination for each component of the media stream, and MUST NOT include any other candidates.  </p>
<p id="rfc.section.4.2.1.2.2.p.4">In addition, if the agent is controlling, it MUST include the a=remote-candidates attribute for each media stream whose check list is in the Completed state.  The attribute contains the remote candidates from the highest-priority nominated pair in the valid list for each component of that media stream.  It is needed to avoid a race condition whereby the controlling agent chooses its pairs, but the updated offer beats the connectivity checks to the controlled agent, which doesn&#8217;t even know these pairs are valid, let alone selected.  See <a href="#sec-why-remote">Appendix B</a> for elaboration on this race condition.  </p>
<h1 id="rfc.section.4.2.1.3"><a href="#rfc.section.4.2.1.3">4.2.1.3.</a> <a href="#sec-sub-lite" id="sec-sub-lite">Procedures for Lite Implementations</a></h1>
<h1 id="rfc.section.4.2.1.3.1"><a href="#rfc.section.4.2.1.3.1">4.2.1.3.1.</a> Existing Media Streams with ICE Running</h1>
<p id="rfc.section.4.2.1.3.1.p.1">This section describes procedures for lite implementations for existing streams for which ICE is running.  </p>
<p id="rfc.section.4.2.1.3.1.p.2">A lite implementation MUST include all of its candidates for each component of each media stream in an a=candidate attribute in any subsequent offer.  These candidates are formed identically to the procedures for initial offers, as described in section 4.2 of <a href="#ICE-BIS">[ICE-BIS]</a>.  </p>
<p id="rfc.section.4.2.1.3.1.p.3">A lite implementation MUST NOT add additional host candidates in a subsequent offer.  If an agent needs to offer additional candidates, it MUST restart ICE.  </p>
<p id="rfc.section.4.2.1.3.1.p.4">The username fragments, password, and implementation level MUST remain the same as used previously.  If an agent needs to change one of these, it MUST restart ICE for that media stream.  </p>
<h1 id="rfc.section.4.2.1.3.2"><a href="#rfc.section.4.2.1.3.2">4.2.1.3.2.</a> Existing Media Streams with ICE Completed</h1>
<p id="rfc.section.4.2.1.3.2.p.1">If ICE has completed for a media stream, the default destination for that media stream MUST be set to the remote candidate of the candidate pair for that component in the valid list.  For a lite implementation, there is always just a single candidate pair in the valid list for each component of a media stream.  Additionally, the agent MUST include a candidate attribute for each default destination.  </p>
<p id="rfc.section.4.2.1.3.2.p.2">Additionally, if the agent is controlling (which only happens when both agents are lite), the agent MUST include the a=remote-candidates attribute for each media stream.  The attribute contains the remote candidates from the candidate pairs in the valid list (one pair for each component of each media stream).  </p>
<h1 id="rfc.section.4.2.2"><a href="#rfc.section.4.2.2">4.2.2.</a> Receiving the Offer and Generating an Answer</h1>
<h1 id="rfc.section.4.2.2.1"><a href="#rfc.section.4.2.2.1">4.2.2.1.</a> Procedures for All Implementations</h1>
<p id="rfc.section.4.2.2.1.p.1">When receiving a subsequent offer within an existing session, an agent MUST reapply the verification procedures in <a href="#sec-verify">Section 4.1.2.3</a> without regard to the results of verification from any previous offer/answer exchanges.  Indeed, it is possible that a previous offer/answer exchange resulted in ICE not being used, but it is used as a consequence of a subsequent exchange.  </p>
<h1 id="rfc.section.4.2.2.1.1"><a href="#rfc.section.4.2.2.1.1">4.2.2.1.1.</a> Detecting ICE Restart</h1>
<p id="rfc.section.4.2.2.1.1.p.1">If the offer contained a change in the a=ice-ufrag or a=ice-pwd attributes compared to the previous SDP from the peer, it indicates that ICE is restarting for this media stream.  If all media streams are restarting, then ICE is restarting overall.  </p>
<p id="rfc.section.4.2.2.1.1.p.2">If ICE is restarting for a media stream: </p>
<p/>

<ul>
  <li>The agent MUST change the a=ice-ufrag and a=ice-pwd attributes in the answer.  </li>
  <li>The agent MAY change its implementation level in the answer.  </li>
</ul>

<p> </p>
<p id="rfc.section.4.2.2.1.1.p.4">An agent sets the rest of the fields in the SDP for this media stream as it would in an initial answer to this media stream (see <a href="#sec-encoding">Section 4.1.1.2</a>).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates.  </p>
<h1 id="rfc.section.4.2.2.1.2"><a href="#rfc.section.4.2.2.1.2">4.2.2.1.2.</a> New Media Stream</h1>
<p id="rfc.section.4.2.2.1.2.p.1">If the offer contains a new media stream, the agent sets the fields in the answer as if it had received an initial offer containing that media stream (see <a href="#sec-encoding">Section 4.1.1.2</a>).  This will cause ICE processing to begin for this media stream.  </p>
<h1 id="rfc.section.4.2.2.1.3"><a href="#rfc.section.4.2.2.1.3">4.2.2.1.3.</a> Removed Media Stream</h1>
<p id="rfc.section.4.2.2.1.3.p.1">If an offer contains a media stream whose port is zero, the agent MUST NOT include any candidate attributes for that media stream in its answer and SHOULD NOT include any other ICE-related attributes defined in <a href="#sec-grammar">Section 5</a> for that media stream.  </p>
<h1 id="rfc.section.4.2.2.2"><a href="#rfc.section.4.2.2.2">4.2.2.2.</a> Procedures for Full Implementations</h1>
<p id="rfc.section.4.2.2.2.p.1">Unless the agent has detected an ICE restart from the offer, the username fragments, password, and implementation level MUST remain the same as used previously.  If an agent needs to change one of these it MUST restart ICE for that media stream by generating an offer; ICE cannot be restarted in an answer.  </p>
<p id="rfc.section.4.2.2.2.p.2">Additional behaviors depend on the state of ICE processing for that media stream.  </p>
<h1 id="rfc.section.4.2.2.2.1"><a href="#rfc.section.4.2.2.2.1">4.2.2.2.1.</a> Existing Media Streams with ICE Running and no remote-candidates</h1>
<p id="rfc.section.4.2.2.2.1.p.1">If ICE is running for a media stream, and the offer for that media stream lacked the remote-candidates attribute, the rules for construction of the answer are identical to those for the offerer as described in <a href="#sec-exist-run">Section 4.2.1.2.1</a>.  </p>
<h1 id="rfc.section.4.2.2.2.2"><a href="#rfc.section.4.2.2.2.2">4.2.2.2.2.</a> Existing Media Streams with ICE Completed and no remote-candidates</h1>
<p id="rfc.section.4.2.2.2.2.p.1">If ICE is Completed for a media stream, and the offer for that media stream lacked the remote-candidates attribute, the rules for construction of the answer are identical to those for the offerer as described in <a href="#sec-exist-comp">Section 4.2.1.2.2</a>, except that the answerer MUST NOT include the a=remote-candidates attribute in the answer.  </p>
<h1 id="rfc.section.4.2.2.2.3"><a href="#rfc.section.4.2.2.2.3">4.2.2.2.3.</a> <a href="#sec-full-existing" id="sec-full-existing">Existing Media Streams and remote-candidates</a></h1>
<p id="rfc.section.4.2.2.2.3.p.1">A controlled agent will receive an offer with the a=remote-candidates attribute for a media stream when its peer has concluded ICE processing for that media stream.  This attribute is present in the offer to deal with a race condition between the receipt of the offer, and the receipt of the Binding Response that tells the answerer the candidate that will be selected by ICE.  See <a href="#sec-why-remote">Appendix B</a> for an explanation of this race condition.  Consequently, processing of an offer with this attribute depends on the winner of the race.  </p>
<p id="rfc.section.4.2.2.2.3.p.2">The agent forms a candidate pair for each component of the media stream by: </p>
<p/>

<ul>
  <li>Setting the remote candidate equal to the offerer&#8217;s default destination for that component (e.g., the contents of the "m=" and "c=" lines for RTP, and the a=rtcp attribute for RTCP) </li>
  <li>Setting the local candidate equal to the transport address for that same component in the a=remote-candidates attribute in the offer.  </li>
</ul>

<p> </p>
<p id="rfc.section.4.2.2.2.3.p.4">The agent then sees if each of these candidate pairs is present in the valid list.  If a particular pair is not in the valid list, the check has "lost" the race.  Call such a pair a "losing pair".  </p>
<p id="rfc.section.4.2.2.2.3.p.5">The agent finds all the pairs in the check list whose remote candidates equal the remote candidate in the losing pair: </p>
<p/>

<ul>
  <li>If none of the pairs are In-Progress, and at least one is Failed, it is most likely that a network failure, such as a network partition or serious packet loss, has occurred.  The agent SHOULD generate an answer for this media stream as if the remote-candidates attribute had not been present, and then restart ICE for this stream.  </li>
  <li>If at least one of the pairs is In-Progress, the agent SHOULD wait for those checks to complete, and as each completes, redo the processing in this section until there are no losing pairs.  </li>
</ul>

<p> </p>
<p id="rfc.section.4.2.2.2.3.p.7">Once there are no losing pairs, the agent can generate the answer.  It MUST set the default destination for media to the candidates in the remote-candidates attribute from the offer (each of which will now be the local candidate of a candidate pair in the valid list).  It MUST include a candidate attribute in the answer for each candidate in the remote-candidates attribute in the offer.  </p>
<h1 id="rfc.section.4.2.2.3"><a href="#rfc.section.4.2.2.3">4.2.2.3.</a> <a href="#sec-this-sucks" id="sec-this-sucks">Procedures for Lite Implementations</a></h1>
<p id="rfc.section.4.2.2.3.p.1">If the received offer contains the remote-candidates attribute for a media stream, the agent forms a candidate pair for each component of the media stream by: </p>
<p/>

<ul>
  <li>Setting the remote candidate equal to the offerer&#8217;s default destination for that component (e.g., the contents of the "m=" and "c=" lines for RTP, and the a=rtcp attribute for RTCP).  </li>
  <li>Setting the local candidate equal to the transport address for that same component in the a=remote-candidates attribute in the offer.  </li>
</ul>

<p> </p>
<p id="rfc.section.4.2.2.3.p.3">It then places those candidates into the Valid list for the media stream.  The state of ICE processing for that media stream is set to Completed.  </p>
<p id="rfc.section.4.2.2.3.p.4">Furthermore, if the agent believed it was controlling, but the offer contained the remote-candidates attribute, both agents believe they are controlling.  In this case, both would have sent updated offers around the same time.  However, the signaling protocol carrying the offer/answer exchanges will have resolved this glare condition, so that one agent is always the 'winner' by having its offer received before its peer has sent an offer.  The winner takes the role of controlling, so that the loser (the answerer under consideration in this section) MUST change its role to controlled.  Consequently, if the agent was going to send an updated offer since, based on the rules in section 6.2 of <a href="#ICE-BIS">[ICE-BIS]</a>, it was controlling, it no longer needs to.  </p>
<p id="rfc.section.4.2.2.3.p.5">Besides the potential role change, change in the Valid list, and state changes, the construction of the answer is performed identically to the construction of an offer as described in <a href="#sec-sub-lite">Section 4.2.1.3</a>.  </p>
<h1 id="rfc.section.4.2.3"><a href="#rfc.section.4.2.3">4.2.3.</a> <a href="#sec-answer-subsequent" id="sec-answer-subsequent">Receiving the Answer for a Subsequent Offer</a></h1>
<p id="rfc.section.4.2.3.p.1">Some deployments of ICE include e.g. SDP-Modifying Signaling-only <a href="#RFC7092">Back-to-Back User Agents (B2BUAs)</a> <cite title="NONE">[RFC7092]</cite> that modify the SDP body during the subsequent offer/answer exchange.  With the B2BUA being ICE-unaware, a subsequent answer might be manipulated and might not include ICE candidates although the initial answer did.  </p>
<p id="rfc.section.4.2.3.p.2">An example of a situation where such an "unexpected" answer might be experienced appears when such a B2BUA introduces a media server during call hold using 3rd party call-control procedures.  Omitting further details how this is done this could result in an answer being received at the holding UA that was constructed by the B2BUA.  With the B2BUA being ICE-unaware, that answer would not include ICE candidates.  </p>
<p id="rfc.section.4.2.3.p.3">Receiving an answer without ICE attributes in this situation might be unexpected, but would not necessarily impair the user experience.  </p>
<p id="rfc.section.4.2.3.p.4">In addition to procedures for the expected answer, the following section advices on how to recover from the unexpected situation.  </p>
<h1 id="rfc.section.4.2.3.1"><a href="#rfc.section.4.2.3.1">4.2.3.1.</a> Procedures for All Implementations</h1>
<p id="rfc.section.4.2.3.1.p.1">When receiving an answer within an existing session for a subsequent offer as specified in <a href="#sec-exist-comp">Section 4.2.1.2.2</a>, an agent MUST verify ICE support as specified in <a href="#sec-overify">Section 4.1.3.1</a>.  </p>
<p id="rfc.section.4.2.3.1.p.2">If ICE support is indicated in the SDP answer and the offer was a restart, the agent MUST perform ICE restart procedures as specified in <a href="#sec-updating">Section 4.2.4</a>. If ICE support is no longer indicated in the SDP answer, the agent MUST fall-back to <a href="#RFC3264">[RFC3264]</a> procedures and SHOULD NOT drop the dialog just because of missing ICE support. If the agent sends a new offer later on, it SHOULD perform an ICE restart as specified in <a href="#sec-suboffer-restarts">Section 4.2.1.1.1</a>.  </p>
<p id="rfc.section.4.2.3.1.p.3">If ICE support is indicated in the SDP answer and ICE is running, the agent MUST continue ICE procedures as specified in <a href="#sec-updating-continuing">Section 4.2.4.1.4</a>. If ICE support is no longer indicated in the SDP answer, the agent MUST abort the ongoing ICE processing and fall-back to <a href="#RFC3264">[RFC3264]</a> procedures. The agent SHOULD NOT drop the dialog just because of missing ICE support. If the agent sends a new offer later on, it SHOULD perform an ICE restart as specified in <a href="#sec-suboffer-restarts">Section 4.2.1.1.1</a>.  </p>
<p id="rfc.section.4.2.3.1.p.4">If ICE support is indicated in the SDP answer and if ICE is completed and the answer conforms to <a href="#sec-full-existing">Section 4.2.2.2.3</a>, the agent MUST remain in the ICE Completed state. If ICE support is no longer indicated in the SDP answer, the agent MUST fall-back to <a href="#RFC3264">[RFC3264]</a> procedures and SHOULD NOT drop the dialog just because of this unexpected answer. Once the agent sends a new offer later on it MUST perform an ICE restart.  </p>
<h1 id="rfc.section.4.2.4"><a href="#rfc.section.4.2.4">4.2.4.</a> <a href="#sec-updating" id="sec-updating">Updating the Check and Valid Lists</a></h1>
<h1 id="rfc.section.4.2.4.1"><a href="#rfc.section.4.2.4.1">4.2.4.1.</a> Procedures for Full Implementations</h1>
<h1 id="rfc.section.4.2.4.1.1"><a href="#rfc.section.4.2.4.1.1">4.2.4.1.1.</a> ICE Restarts</h1>
<p id="rfc.section.4.2.4.1.1.p.1">The agent MUST remember the highest-priority nominated pairs in the Valid list for each component of the media stream, called the previous selected pairs, prior to the restart.  The agent will continue to send media using these pairs, as described in <a href="#sec-send_media">Section 7.1</a>.  Once these destinations are noted, the agent MUST flush the valid and check lists, and then recompute the check list and its states as described in section 5.1.3 of <a href="#ICE-BIS">[ICE-BIS]</a>.  </p>
<h1 id="rfc.section.4.2.4.1.2"><a href="#rfc.section.4.2.4.1.2">4.2.4.1.2.</a> New Media Stream</h1>
<p id="rfc.section.4.2.4.1.2.p.1">If the offer/answer exchange added a new media stream, the agent MUST create a new check list for it (and an empty Valid list to start of course), as described in section 5.1.3 of <a href="#ICE-BIS">[ICE-BIS]</a>.  </p>
<h1 id="rfc.section.4.2.4.1.3"><a href="#rfc.section.4.2.4.1.3">4.2.4.1.3.</a> Removed Media Stream</h1>
<p id="rfc.section.4.2.4.1.3.p.1">If the offer/answer exchange removed a media stream, or an answer rejected an offered media stream, an agent MUST flush the Valid list for that media stream.  It MUST terminate any STUN transactions in progress for that media stream.  An agent MUST remove the check list for that media stream and cancel any pending ordinary checks for it.  </p>
<h1 id="rfc.section.4.2.4.1.4"><a href="#rfc.section.4.2.4.1.4">4.2.4.1.4.</a> <a href="#sec-updating-continuing" id="sec-updating-continuing">ICE Continuing for Existing Media Stream</a></h1>
<p id="rfc.section.4.2.4.1.4.p.1">The valid list is not affected by an updated offer/answer exchange unless ICE is restarting.  </p>
<p id="rfc.section.4.2.4.1.4.p.2">If an agent is in the Running state for that media stream, the check list is updated (the check list is irrelevant if the state is completed).  To do that, the agent recomputes the check list using the procedures described in section 5.1.3 of <a href="#ICE-BIS">[ICE-BIS]</a>.  If a pair on the new check list was also on the previous check list, and its state was Waiting, In-Progress, Succeeded, or Failed, its state is copied over.  Otherwise, its state is set to Frozen.  </p>
<p id="rfc.section.4.2.4.1.4.p.3">If none of the check lists are active (meaning that the pairs in each check list are Frozen), the full-mode agent sets the first pair in the check list for the first media stream to Waiting, and then sets the state of all other pairs in that check list for the same component ID and with the same foundation to Waiting as well.  </p>
<p id="rfc.section.4.2.4.1.4.p.4">Next, the agent goes through each check list, starting with the highest-priority pair.  If a pair has a state of Succeeded, and it has a component ID of 1, then all Frozen pairs in the same check list with the same foundation whose component IDs are not 1 have their state set to Waiting.  If, for a particular check list, there are pairs for each component of that media stream in the Succeeded state, the agent moves the state of all Frozen pairs for the first component of all other media streams (and thus in different check lists) with the same foundation to Waiting.  </p>
<h1 id="rfc.section.4.2.4.2"><a href="#rfc.section.4.2.4.2">4.2.4.2.</a> Procedures for Lite Implementations</h1>
<p id="rfc.section.4.2.4.2.p.1">If ICE is restarting for a media stream, the agent MUST start a new Valid list for that media stream.  It MUST remember the pairs in the previous Valid list for each component of the media stream, called the previous selected pairs, and continue to send media there as described in <a href="#sec-send_media">Section 7.1</a>.  The state of ICE processing for each media stream MUST change to Running, and the state of ICE processing MUST change to Running.  </p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#sec-grammar" id="sec-grammar">Grammar</a></h1>
<p id="rfc.section.5.p.1">This specification defines eight new SDP attributes&#8201;&#8212;&#8201;the "candidate", "remote-candidates", "ice-lite", "ice-mismatch", "ice-ufrag", "ice-pwd", "ice-pacing", and "ice-options" attributes.  </p>
<h1 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a> "candidate" Attribute</h1>
<p id="rfc.section.5.1.p.1">The candidate attribute is a media-level attribute only.  It contains a transport address for a candidate that can be used for connectivity checks.  </p>
<p id="rfc.section.5.1.p.2">The syntax of this attribute is defined using Augmented BNF as defined in <a href="#RFC5234">[RFC5234]</a>: </p>
<pre>
candidate-attribute   = "candidate" ":" foundation SP component-id SP
                        transport SP
                        priority SP
                        connection-address SP     ;from RFC 4566
                        port         ;port from RFC 4566
                        SP cand-type
                        [SP rel-addr]
                        [SP rel-port]
                        *(SP extension-att-name SP
                             extension-att-value)

foundation            = 1*32ice-char
component-id          = 1*5DIGIT
transport             = "UDP" / transport-extension
transport-extension   = token              ; from RFC 3261
priority              = 1*10DIGIT
cand-type             = "typ" SP candidate-types
candidate-types       = "host" / "srflx" / "prflx" / "relay" / token
rel-addr              = "raddr" SP connection-address
rel-port              = "rport" SP port
extension-att-name    = token
extension-att-value   = *VCHAR
ice-char              = ALPHA / DIGIT / "+" / "/"
</pre>
<p id="rfc.section.5.1.p.3">This grammar encodes the primary information about a candidate: its IP address, port and transport protocol, and its properties: the foundation, component ID, priority, type, and related transport address: </p>
<p/>

<dl>
  <dt>&lt;connection-address&gt;:</dt>
  <dd style="margin-left: 8">is taken from RFC 4566 <a href="#RFC4566">[RFC4566]</a>.  It is the IP address of the candidate, allowing for IPv4 addresses, IPv6 addresses, and fully qualified domain names (FQDNs).  When parsing this field, an agent can differentiate an IPv4 address and an IPv6 address by presence of a colon in its value&#8201;&#8212;&#8201;the presence of a colon indicates IPv6.  An agent MUST ignore candidate lines that include candidates with IP address versions that are not supported or recognized.  An IP address SHOULD be used, but an FQDN MAY be used in place of an IP address.  In that case, when receiving an offer or answer containing an FQDN in an a=candidate attribute, the FQDN is looked up in the DNS first using an AAAA record (assuming the agent supports IPv6), and if no result is found or the agent only supports IPv4, using an A record.  If the DNS query returns more than one IP address, one is chosen, and then used for the remainder of ICE processing.  </dd>
  <dt>&lt;port&gt;:</dt>
  <dd style="margin-left: 8">is also taken from RFC 4566 <a href="#RFC4566">[RFC4566]</a>.  It is the port of the candidate.  </dd>
  <dt>&lt;transport&gt;:</dt>
  <dd style="margin-left: 8">indicates the transport protocol for the candidate.  This specification only defines UDP.  However, extensibility is provided to allow for future transport protocols to be used with ICE, such as the Datagram Congestion Control Protocol (DCCP) <a href="#RFC4340">[RFC4340]</a>.  </dd>
  <dt>&lt;foundation&gt;:</dt>
  <dd style="margin-left: 8">is composed of 1 to 32 &lt;ice-char&gt;s.  It is an identifier that is equivalent for two candidates that are of the same type, share the same base, and come from the same STUN server.  The foundation is used to optimize ICE performance in the Frozen algorithm.  </dd>
  <dt>&lt;component-id&gt;:</dt>
  <dd style="margin-left: 8">is a positive integer between 1 and 256 that identifies the specific component of the media stream for which this is a candidate.  It MUST start at 1 and MUST increment by 1 for each component of a particular candidate.  For media streams based on RTP, candidates for the actual RTP media MUST have a component ID of 1, and candidates for RTCP MUST have a component ID of 2.  See section 10 in <a href="#ICE-BIS">[ICE-BIS]</a> for additional discussion on extending ICE to new media streams.  </dd>
  <dt>&lt;priority&gt;:</dt>
  <dd style="margin-left: 8">is a positive integer between 1 and (2**31 - 1).  </dd>
  <dt>&lt;cand-type&gt;:</dt>
  <dd style="margin-left: 8">encodes the type of candidate.  This specification defines the values "host", "srflx", "prflx", and "relay" for host, server reflexive, peer reflexive, and relayed candidates, respectively.  The set of candidate types is extensible for the future.  </dd>
  <dt>&lt;rel-addr&gt; and &lt;rel-port&gt;:</dt>
  <dd style="margin-left: 8">convey transport addresses related to the candidate, useful for diagnostics and other purposes.  &lt;rel-addr&gt; and &lt;rel-port&gt; MUST be present for server reflexive, peer reflexive, and relayed candidates.  If a candidate is server or peer reflexive, &lt;rel-addr&gt; and &lt;rel-port&gt; are equal to the base for that server or peer reflexive candidate.  If the candidate is relayed, &lt;rel-addr&gt; and &lt;rel-port&gt; are equal to the mapped address in the Allocate response that provided the client with that relayed candidate (see section Appendix B.3 of <a href="#ICE-BIS">[ICE-BIS]</a> for a discussion of its purpose).  If the candidate is a host candidate, &lt;rel-addr&gt; and &lt;rel-port&gt; MUST be omitted.  </dd>
  <dt></dt>
  <dd style="margin-left: 8">In some cases, e.g., for privacy reasons, an agent may not want to reveal the related address and port.  In this case the address MUST be set to "0.0.0.0" (for IPv4 candidates) or "::" (for IPv6 candidates) and the port to zero.  </dd>
</dl>

<p> </p>
<p id="rfc.section.5.1.p.5">The candidate attribute can itself be extended.  The grammar allows for new name/value pairs to be added at the end of the attribute.  An implementation MUST ignore any name/value pairs it doesn&#8217;t understand.  </p>
<h1 id="rfc.section.5.2"><a href="#rfc.section.5.2">5.2.</a> "remote-candidates" Attribute</h1>
<p id="rfc.section.5.2.p.1">The syntax of the "remote-candidates" attribute is defined using Augmented BNF as defined in <a href="#RFC5234">[RFC5234]</a>.  The remote-candidates attribute is a media-level attribute only.  </p>
<pre>
remote-candidate-att = "remote-candidates:" remote-candidate
                         0*(SP remote-candidate)
remote-candidate = component-ID SP connection-address SP port
</pre>
<p id="rfc.section.5.2.p.2">The attribute contains a connection-address and port for each component.  The ordering of components is irrelevant.  However, a value MUST be present for each component of a media stream.  This attribute MUST be included in an offer by a controlling agent for a media stream that is Completed, and MUST NOT be included in any other case.  </p>
<h1 id="rfc.section.5.3"><a href="#rfc.section.5.3">5.3.</a> "ice-lite" and "ice-mismatch" Attributes</h1>
<p id="rfc.section.5.3.p.1">The syntax of the "ice-lite" and "ice-mismatch" attributes, both of which are flags, is: </p>
<pre>
ice-lite               = "ice-lite"
ice-mismatch           = "ice-mismatch"
</pre>
<p id="rfc.section.5.3.p.2">"ice-lite" is a session-level attribute only, and indicates that an agent is a lite implementation.  "ice-mismatch" is a media-level attribute only, and when present in an answer, indicates that the offer arrived with a default destination for a media component that didn&#8217;t have a corresponding candidate attribute.  </p>
<h1 id="rfc.section.5.4"><a href="#rfc.section.5.4">5.4.</a> "ice-ufrag" and "ice-pwd" Attributes</h1>
<p id="rfc.section.5.4.p.1">The "ice-ufrag" and "ice-pwd" attributes convey the username fragment and password used by ICE for message integrity.  Their syntax is: </p>
<pre>
ice-pwd-att           = "ice-pwd:" password
ice-ufrag-att         = "ice-ufrag:" ufrag
password              = 22*256ice-char
ufrag                 = 4*256ice-char
</pre>
<p id="rfc.section.5.4.p.2">The "ice-pwd" and "ice-ufrag" attributes can appear at either the session-level or media-level.  When present in both, the value in the media-level takes precedence.  Thus, the value at the session-level is effectively a default that applies to all media streams, unless overridden by a media-level value.  Whether present at the session or media-level, there MUST be an ice-pwd and ice-ufrag attribute for each media stream.  If two media streams have identical ice-ufrag&#8217;s, they MUST have identical ice-pwd&#8217;s.  </p>
<p id="rfc.section.5.4.p.3">The ice-ufrag and ice-pwd attributes MUST be chosen randomly at the beginning of a session.  The ice-ufrag attribute MUST contain at least 24 bits of randomness, and the ice-pwd attribute MUST contain at least 128 bits of randomness.  This means that the ice-ufrag attribute will be at least 4 characters long, and the ice-pwd at least 22 characters long, since the grammar for these attributes allows for 6 bits of information per character.  The attributes MAY be longer than 4 and 22 characters, respectively, of course, up to 256 characters.  The upper limit allows for buffer sizing in implementations.  Its large upper limit allows for increased amounts of randomness to be added over time.  For compatibility with the 512 character limitation for the STUN username attribute value and for bandwidth conservation considerations, the ice-ufrag attribute MUST NOT be longer than 32 characters when sending, but an implementation  MUST accept up to 256 characters when receiving.  </p>
<h1 id="rfc.section.5.5"><a href="#rfc.section.5.5">5.5.</a> "ice-pacing" Attribute</h1>
<p id="rfc.section.5.5.p.1">The "ice-pacing" attribute indicates the desired connectivity check pacing, in milliseconds, for this agent (see section 11 of <a href="#ICE-BIS">[ICE-BIS]</a>).  The syntax is: </p>
<pre>
ice-pacing-att            = "ice-pacing:" pacing-value
pacing-value              = 1*10DIGIT
</pre>
<h1 id="rfc.section.5.6"><a href="#rfc.section.5.6">5.6.</a> <a href="#sec-ice-options" id="sec-ice-options">"ice-options" Attribute</a></h1>
<p id="rfc.section.5.6.p.1">The "ice-options" attribute is a session- and media-level attribute.  It contains a series of tokens that identify the options supported by the agent.  Its grammar is: </p>
<pre>
ice-options           = "ice-options:" ice-option-tag
                          0*(SP ice-option-tag)
ice-option-tag        = 1*ice-char
</pre>
<p id="rfc.section.5.6.p.2">The existence of an ice-option can indicate that a certain extension is supported by the agent and will be used or that the extension is used only if the other agent is willing to use it too.  In order to avoid ambiguity, documents defining new options must indicate which case applies to the defined extensions.  </p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#sec-keepalive" id="sec-keepalive">Keepalives</a></h1>
<p id="rfc.section.6.p.1">The procedures defined in section 8 of <a href="#ICE-BIS">[ICE-BIS]</a> MUST be followed.  The keepalives MUST be sent regardless of whether the media stream is currently inactive, sendonly, recvonly, or sendrecv, and regardless of the presence or value of the bandwidth attribute.  An agent can determine that its peer supports ICE by the presence of a=candidate attributes for each media session.  </p>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> Media Handling</h1>
<h1 id="rfc.section.7.1"><a href="#rfc.section.7.1">7.1.</a> <a href="#sec-send_media" id="sec-send_media">Sending Media</a></h1>
<p id="rfc.section.7.1.p.1">The selected pair for a component of a media stream might not equal the default pair for that same component from the most recent offer/answer exchange.  When this happens, the selected pair is used for media, not the default pair.  When ICE first completes, if the selected pairs aren&#8217;t a match for the default pairs, the controlling agent sends an updated offer/answer exchange to remedy this disparity.  However, until that updated offer arrives, there will not be a match.  Furthermore, in very unusual cases, the default candidates in the updated offer/answer will not be a match.  </p>
<h1 id="rfc.section.7.1.1"><a href="#rfc.section.7.1.1">7.1.1.</a> Procedures for All Implementations</h1>
<p id="rfc.section.7.1.1.p.1">section 9.1.3 of <a href="#ICE-BIS">[ICE-BIS]</a> defines procedures for sending media common across Full and Lite implementations.  </p>
<h1 id="rfc.section.7.2"><a href="#rfc.section.7.2">7.2.</a> <a href="#sec-recv_media" id="sec-recv_media">Receiving Media</a></h1>
<p id="rfc.section.7.2.p.1">See section 9.2 of <a href="#ICE-BIS">[ICE-BIS]</a> for procedures on receiving media.  </p>
<h1 id="rfc.section.8"><a href="#rfc.section.8">8.</a> Usage with SIP</h1>
<h1 id="rfc.section.8.1"><a href="#rfc.section.8.1">8.1.</a> <a href="#sec-latency" id="sec-latency">Latency Guidelines</a></h1>
<p id="rfc.section.8.1.p.1">ICE requires a series of STUN-based connectivity checks to take place between endpoints.  These checks start from the answerer on generation of its answer, and start from the offerer when it receives the answer.  These checks can take time to complete, and as such, the selection of messages to use with offers and answers can affect perceived user latency.  Two latency figures are of particular interest.  These are the post-pickup delay and the post-dial delay.  The post-pickup delay refers to the time between when a user "answers the phone" and when any speech they utter can be delivered to the caller.  The post-dial delay refers to the time between when a user enters the destination address for the user and ringback begins as a consequence of having successfully started alerting the called user agent.  </p>
<p id="rfc.section.8.1.p.2">Two cases can be considered&#8201;&#8212;&#8201;one where the offer is present in the initial INVITE and one where it is in a response.  </p>
<h1 id="rfc.section.8.1.1"><a href="#rfc.section.8.1.1">8.1.1.</a> Offer in INVITE</h1>
<p id="rfc.section.8.1.1.p.1">To reduce post-dial delays, it is RECOMMENDED that the caller begin gathering candidates prior to actually sending its initial INVITE.  This can be started upon user interface cues that a call is pending, such as activity on a keypad or the phone going off-hook.  </p>
<p id="rfc.section.8.1.1.p.2">On the receipt of the offer, the answerer SHOULD generate an answer in a provisional response once it has compelted candidate gathering. ICE requires that a provisional response with an SDP be transmitted reliably. This can be done through the existing Provisional Response Acknowledgment (PRACK) mechanism <a href="#RFC3262">[RFC3262]</a> or through an ICE specific optimization, wherein, the agent retransmits the provisional response with the exponential backoff timers described in <a href="#RFC3262">[RFC3262]</a>. Such retransmissions MUST cease on receipt of a STUN Binding request for one of the media streams signaled in that SDP or on transmission of the answer in a 2xx response. If no Binding request is received prior to the last retransmit, the agent does not consider the session terminated. For the ICE lite peers, the agent MUST cease retransmitting the 18x after sending it four times (ICE will actually work even if the peer never receives the 18x; however, experience has shown that sending it is important for middleboxes and firewall traversal).  </p>
<p id="rfc.section.8.1.1.p.3">It should be noted that the ICE specific optimization is very specific to provisional response carrying answers that start ICE processing and it is not a general technique for 1xx reliability. Also such an optimization SHOULD NOT be used if both agents support PRACK.  </p>
<p id="rfc.section.8.1.1.p.4">Despite the fact that the provisional response will be delivered reliably, the rules for when an agent can send an updated offer or answer do not change from those specified in <a href="#RFC3262">[RFC3262]</a>.  Specifically, if the INVITE contained an offer, the same answer appears in all of the 1xx and in the 2xx response to the INVITE. Only after that 2xx has been sent can an updated offer/answer exchange occur.  </p>
<p id="rfc.section.8.1.1.p.5">Alternatively, an agent MAY delay sending an answer until the 200 OK; however, this results in a poor user experience and is NOT RECOMMENDED.  </p>
<p id="rfc.section.8.1.1.p.6">Once the answer has been sent, the agent SHOULD begin its connectivity checks.  Once candidate pairs for each component of a media stream enter the valid list, the answerer can begin sending media on that media stream.  </p>
<p id="rfc.section.8.1.1.p.7">However, prior to this point, any media that needs to be sent towards the caller (such as SIP early media <a href="#RFC3960">[RFC3960]</a>) MUST NOT be transmitted.  For this reason, implementations SHOULD delay alerting the called party until candidates for each component of each media stream have entered the valid list.  In the case of a PSTN gateway, this would mean that the setup message into the PSTN is delayed until this point.  Doing this increases the post-dial delay, but has the effect of eliminating 'ghost rings'.  Ghost rings are cases where the called party hears the phone ring, picks up, but hears nothing and cannot be heard.  This technique works without requiring support for, or usage of, preconditions <a href="#RFC3312">[RFC3312]</a>, since it&#8217;s a localized decision.  It also has the benefit of guaranteeing that not a single packet of media will get clipped, so that post-pickup delay is zero.  If an agent chooses to delay local alerting in this way, it SHOULD generate a 180 response once alerting begins.  </p>
<h1 id="rfc.section.8.1.2"><a href="#rfc.section.8.1.2">8.1.2.</a> Offer in Response</h1>
<p id="rfc.section.8.1.2.p.1">In addition to uses where the offer is in an INVITE, and the answer is in the provisional and/or 200 OK response, ICE works with cases where the offer appears in the response.  In such cases, which are common in third party call control <a href="#RFC3725">[RFC3725]</a>, ICE agents SHOULD generate their offers in a reliable provisional response (which MUST utilize <a href="#RFC3262">[RFC3262]</a>), and not alert the user on receipt of the INVITE.  The answer will arrive in a PRACK.  This allows for ICE processing to take place prior to alerting, so that there is no post-pickup delay, at the expense of increased call setup delays.  Once ICE completes, the callee can alert the user and then generate a 200 OK when they answer.  The 200 OK would contain no SDP, since the offer/answer exchange has completed.  </p>
<p id="rfc.section.8.1.2.p.2">Alternatively, agents MAY place the offer in a 2xx instead (in which case the answer comes in the ACK).  When this happens, the callee will alert the user on receipt of the INVITE, and the ICE exchanges will take place only after the user answers.  This has the effect of reducing call setup delay, but can cause substantial post-pickup delays and media clipping.  </p>
<h1 id="rfc.section.8.2"><a href="#rfc.section.8.2">8.2.</a> SIP Option Tags and Media Feature Tags</h1>
<p><a href="#RFC5768">[RFC5768]</a> specifies a SIP option tag and media feature tag for usage with ICE.  ICE implementations using SIP SHOULD support this specification, which uses a feature tag in registrations to facilitate interoperability through signaling intermediaries.  </p>
<h1 id="rfc.section.8.3"><a href="#rfc.section.8.3">8.3.</a> Interactions with Forking</h1>
<p id="rfc.section.8.3.p.1">ICE interacts very well with forking.  Indeed, ICE fixes some of the problems associated with forking.  Without ICE, when a call forks and the caller receives multiple incoming media streams, it cannot determine which media stream corresponds to which callee.  </p>
<p id="rfc.section.8.3.p.2">With ICE, this problem is resolved.  The connectivity checks which occur prior to transmission of media carry username fragments, which in turn are correlated to a specific callee.  Subsequent media packets that arrive on the same candidate pair as the connectivity check will be associated with that same callee.  Thus, the caller can perform this correlation as long as it has received an answer.  </p>
<h1 id="rfc.section.8.4"><a href="#rfc.section.8.4">8.4.</a> Interactions with Preconditions</h1>
<p id="rfc.section.8.4.p.1">Quality of Service (QoS) preconditions, which are defined in <a href="#RFC3312">[RFC3312]</a> and <a href="#RFC4032">[RFC4032]</a>, apply only to the transport addresses listed as the default targets for media in an offer/answer.  If ICE changes the transport address where media is received, this change is reflected in an updated offer that changes the default destination for media to match ICE&#8217;s selection.  As such, it appears like any other re-INVITE would, and is fully treated in RFCs 3312 and 4032, which apply without regard to the fact that the destination for media is changing due to ICE negotiations occurring "in the background".  </p>
<p id="rfc.section.8.4.p.2">Indeed, an agent SHOULD NOT indicate that QoS preconditions have been met until the checks have completed and selected the candidate pairs to be used for media.  </p>
<p id="rfc.section.8.4.p.3">ICE also has (purposeful) interactions with connectivity preconditions <a href="#RFC5898">[RFC5898]</a>.  Those interactions are described there.  Note that the procedures described in <a href="#sec-latency">Section 8.1</a> describe their own type of "preconditions", albeit with less functionality than those provided by the explicit preconditions in <a href="#RFC5898">[RFC5898]</a>.  </p>
<h1 id="rfc.section.8.5"><a href="#rfc.section.8.5">8.5.</a> Interactions with Third Party Call Control</h1>
<p id="rfc.section.8.5.p.1">ICE works with Flows I, III, and IV as described in <a href="#RFC3725">[RFC3725]</a>.  Flow I works without the controller supporting or being aware of ICE.  Flow IV will work as long as the controller passes along the ICE attributes without alteration.  Flow II is fundamentally incompatible with ICE; each agent will believe itself to be the answerer and thus never generate a re-INVITE.  </p>
<p id="rfc.section.8.5.p.2">The flows for continued operation, as described in Section 7 of <a href="#RFC3725">[RFC3725]</a>, require additional behavior of ICE implementations to support.  In particular, if an agent receives a mid-dialog re-INVITE that contains no offer, it MUST restart ICE for each media stream and go through the process of gathering new candidates.  Furthermore, that list of candidates SHOULD include the ones currently being used for media.  </p>
<h1 id="rfc.section.9"><a href="#rfc.section.9">9.</a> Setting Ta and RTO for RTP Media Streams</h1>
<p id="rfc.section.9.p.1">During the gathering phase of ICE (section 4.1.1 <a href="#ICE-BIS">[ICE-BIS]</a>) and while ICE is performing connectivity checks (section 6 <a href="#ICE-BIS">[ICE-BIS]</a>), an agent sends STUN and TURN transactions.  These transactions are paced at a rate of one every Ta milliseconds, and utilize a specific RTO.  See Section 11 of <a href="#ICE-BIS">[ICE-BIS]</a> for details on how the values of Ta and RTO are computed with a real-time media stream of known maximum bandwidth to rate-control the ICE exchanges.  </p>
<h1 id="rfc.section.10"><a href="#rfc.section.10">10.</a> Security Considerations</h1>
<h1 id="rfc.section.10.1"><a href="#rfc.section.10.1">10.1.</a> Attacks on the Offer/Answer Exchanges</h1>
<p id="rfc.section.10.1.p.1">An attacker that can modify or disrupt the offer/answer exchanges themselves can readily launch a variety of attacks with ICE.  They could direct media to a target of a DoS attack, they could insert themselves into the media stream, and so on.  These are similar to the general security considerations for offer/answer exchanges, and the security considerations in <a href="#RFC3264">[RFC3264]</a> apply.  These require techniques for message integrity and encryption for offers and answers, which are satisfied by the TLS mechanism <a href="#RFC3261">[RFC3261]</a> when SIP is used.  As such, the usage of TLS with ICE is RECOMMENDED.  </p>
<h1 id="rfc.section.10.2"><a href="#rfc.section.10.2">10.2.</a> Insider Attacks</h1>
<p id="rfc.section.10.2.p.1">In addition to attacks where the attacker is a third party trying to insert fake offers, answers, or STUN messages, there are several attacks possible with ICE when the attacker is an authenticated and valid participant in the ICE exchange.  </p>
<h1 id="rfc.section.10.2.1"><a href="#rfc.section.10.2.1">10.2.1.</a> <a href="#sec-voice-hammer" id="sec-voice-hammer">The Voice Hammer Attack</a></h1>
<p id="rfc.section.10.2.1.p.1">The voice hammer attack is an amplification attack.  In this attack, the attacker initiates sessions to other agents, and maliciously includes the IP address and port of a DoS target as the destination for media traffic signaled in the SDP.  This causes substantial amplification; a single offer/answer exchange can create a continuing flood of media packets, possibly at high rates (consider video sources).  This attack is not specific to ICE, but ICE can help provide remediation.  </p>
<p id="rfc.section.10.2.1.p.2">Specifically, if ICE is used, the agent receiving the malicious SDP will first perform connectivity checks to the target of media before sending media there.  If this target is a third-party host, the checks will not succeed, and media is never sent.  </p>
<p id="rfc.section.10.2.1.p.3">Unfortunately, ICE doesn&#8217;t help if it&#8217;s not used, in which case an attacker could simply send the offer without the ICE parameters.  However, in environments where the set of clients is known, and is limited to ones that support ICE, the server can reject any offers or answers that don&#8217;t indicate ICE support.  </p>
<p id="rfc.section.10.2.1.p.4">User Agents that are not willing to receive non-ICE answers MUST include an "ice" Option Tag in the Require Header Field in their offer.  Clients that rejects non-ICE offers SHOULD use a 421 response code, together with an Option Tag "ice" in the Require Header Field in the response.  </p>
<h1 id="rfc.section.10.2.2"><a href="#rfc.section.10.2.2">10.2.2.</a> <a href="#sec-alg-sip" id="sec-alg-sip">Interactions with Application Layer Gateways and SIP</a></h1>
<p id="rfc.section.10.2.2.p.1">Application Layer Gateways (ALGs) are functions present in a Network Address Translation (NAT) device that inspect the contents of packets and modify them, in order to facilitate NAT traversal for application protocols.  Session Border Controllers (SBCs) are close cousins of ALGs, but are less transparent since they actually exist as application-layer SIP intermediaries.  ICE has interactions with SBCs and ALGs.  </p>
<p id="rfc.section.10.2.2.p.2">If an ALG is SIP aware but not ICE aware, ICE will work through it as long as the ALG correctly modifies the SDP.  A correct ALG implementation behaves as follows: </p>
<p/>

<ul>
  <li>The ALG does not modify the "m=" and "c=" lines or the rtcp attribute if they contain external addresses.  </li>
  <li>If the "m=" and "c=" lines contain internal addresses, the modification depends on the state of the ALG: <ul class="empty"><li>If the ALG already has a binding established that maps an external port to an internal IP address and port matching the values in the "m=" and "c=" lines or rtcp attribute, the ALG uses that binding instead of creating a new one.  </li><li>If the ALG does not already have a binding, it creates a new one and modifies the SDP, rewriting the "m=" and "c=" lines and rtcp attribute.  </li></ul></li>
</ul>

<p> </p>
<p id="rfc.section.10.2.2.p.4">Unfortunately, many ALGs are known to work poorly in these corner cases.  ICE does not try to work around broken ALGs, as this is outside the scope of its functionality.  ICE can help diagnose these conditions, which often show up as a mismatch between the set of candidates and the "m=" and "c=" lines and rtcp attributes.  The ice-mismatch attribute is used for this purpose.  </p>
<p id="rfc.section.10.2.2.p.5">ICE works best through ALGs when the signaling is run over TLS.  This prevents the ALG from manipulating the SDP messages and interfering with ICE operation.  Implementations that are expected to be deployed behind ALGs SHOULD provide for TLS transport of the SDP.  </p>
<p id="rfc.section.10.2.2.p.6">If an SBC is SIP aware but not ICE aware, the result depends on the behavior of the SBC.  If it is acting as a proper Back-to-Back User Agent (B2BUA), the SBC will remove any SDP attributes it doesn&#8217;t understand, including the ICE attributes.  Consequently, the call will appear to both endpoints as if the other side doesn&#8217;t support ICE.  This will result in ICE being disabled, and media flowing through the SBC, if the SBC has requested it.  If, however, the SBC passes the ICE attributes without modification, yet modifies the default destination for media (contained in the "m=" and "c=" lines and rtcp attribute), this will be detected as an ICE mismatch, and ICE processing is aborted for the call.  It is outside of the scope of ICE for it to act as a tool for "working around" SBCs.  If one is present, ICE will not be used and the SBC techniques take precedence.  </p>
<h1 id="rfc.section.11"><a href="#rfc.section.11">11.</a> <a href="#iana" id="iana">IANA Considerations</a></h1>
<h1 id="rfc.section.11.1"><a href="#rfc.section.11.1">11.1.</a> SDP Attributes</h1>
<p id="rfc.section.11.1.p.1">The original ICE specification defined seven new SDP attributes per the procedures of Section 8.2.4 of <a href="#RFC4566">[RFC4566]</a>.  The registration information is reproduced here.  </p>
<h1 id="rfc.section.11.1.1"><a href="#rfc.section.11.1.1">11.1.1.</a> candidate Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">candidate </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">candidate </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">media-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and provides one of many possible candidate addresses for communication.  These addresses are validated with an end-to-end connectivity check using Session Traversal Utilities for NAT (STUN).  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.2"><a href="#rfc.section.11.1.2">11.1.2.</a> remote-candidates Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">remote-candidates </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">remote-candidates </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">media-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and provides the identity of the remote candidates that the offerer wishes the answerer to use in its answer.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.3"><a href="#rfc.section.11.1.3">11.1.3.</a> ice-lite Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">ice-lite </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">ice-lite </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">session-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and indicates that an agent has the minimum functionality required to support ICE inter-operation with a peer that has a full implementation.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.4"><a href="#rfc.section.11.1.4">11.1.4.</a> ice-mismatch Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">ice-mismatch </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">ice-mismatch </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">session-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and indicates that an agent is ICE capable, but did not proceed with ICE due to a mismatch of candidates with the default destination for media signaled in the SDP.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.5"><a href="#rfc.section.11.1.5">11.1.5.</a> ice-pwd Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">ice-pwd </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">ice-pwd </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">session- or media-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and provides the password used to protect STUN connectivity checks.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.6"><a href="#rfc.section.11.1.6">11.1.6.</a> ice-ufrag Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">ice-ufrag </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">ice-ufrag </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">session- or media-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and provides the fragments used to construct the username in STUN connectivity checks.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.7"><a href="#rfc.section.11.1.7">11.1.7.</a> ice-pacing Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">ice-pacing </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">ice-pacing </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">session-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE) to indicate desired connectivity check pacing values.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.1.8"><a href="#rfc.section.11.1.8">11.1.8.</a> ice-options Attribute</h1>
<p/>

<dl>
  <dt>Contact Name:</dt>
  <dd style="margin-left: 8">Jonathan Rosenberg, jdrosen@jdrosen.net.  </dd>
  <dt>Attribute Name:</dt>
  <dd style="margin-left: 8">ice-options </dd>
  <dt>Long Form:</dt>
  <dd style="margin-left: 8">ice-options </dd>
  <dt>Type of Attribute:</dt>
  <dd style="margin-left: 8">session- or media-level </dd>
  <dt>Charset Considerations:</dt>
  <dd style="margin-left: 8">The attribute is not subject to the charset attribute.  </dd>
  <dt>Purpose:</dt>
  <dd style="margin-left: 8">This attribute is used with Interactive Connectivity Establishment (ICE), and indicates the ICE options or extensions used by the agent.  </dd>
  <dt>Appropriate Values:</dt>
  <dd style="margin-left: 8">See <a href="#sec-grammar">Section 5</a> of RFC XXXX.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.11.2"><a href="#rfc.section.11.2">11.2.</a> Interactive Connectivity Establishment (ICE) Options Registry</h1>
<p id="rfc.section.11.2.p.1">IANA maintains a registry for ice-options identifiers under the Specification Required policy as defined in "Guidelines for Writing an IANA Considerations Section in RFCs" <a href="#RFC5226">[RFC5226]</a>.  </p>
<p id="rfc.section.11.2.p.2">ICE options are of unlimited length according to the syntax in <a href="#sec-ice-options">Section 5.6</a>; however, they are RECOMMENDED to be no longer than 20 characters.  This is to reduce message sizes and allow for efficient parsing.  </p>
<p id="rfc.section.11.2.p.3">In <a href="#RFC5245">[RFC5245]</a> ICE options could only be defined at the session level.  ICE options can now also be defined at the media level.  This can be used when aggregating between different ICE agents in the same endpoint, but future options may require to be defined at the media-level.  To ensure compatibility with legacy implementation, the media-level ICE options MUST be aggregated into a session-level ICE option.  Because aggregation rules depend on the specifics of each option, all new ICE options MUST also define in their specification how the media-level ICE option values are aggregated to generate the value of the session-level ICE option.  </p>
<p><a href="#RFC6679">[RFC6679]</a> defines the "rtp+ecn" ICE option.  The aggregation rule for this ICE option is that if all aggregated media using ICE contain a media-level "rtp+ecn" ICE option then an "rtp+ecn" ICE option MUST be inserted at the session-level.  If one of the media does not contain the option, then it MUST NOT be inserted at the session-level.  </p>
<p id="rfc.section.11.2.p.5">Section 7 of <a href="#ICE-BIS">[ICE-BIS]</a> defines "ice2" ICE option.  Since "ice2" is a session level ICE option, no aggregation rules apply.  </p>
<p id="rfc.section.11.2.p.6">A registration request MUST include the following information: </p>
<p/>

<ul>
  <li>The ICE option identifier to be registered </li>
  <li>Name, Email, and Address of a contact person for the registration </li>
  <li>Organization or individuals having the change control </li>
  <li>Short description of the ICE extension to which the option relates </li>
  <li>Reference(s) to the specification defining the ICE option and the related extensions </li>
</ul>

<p> </p>
<h1 id="rfc.section.12"><a href="#rfc.section.12">12.</a> Acknowledgments</h1>
<p id="rfc.section.12.p.1">A large part of the text in this document was taken from <a href="#RFC5245">[RFC5245]</a>, authored by Jonathan Rosenberg.  </p>
<p id="rfc.section.12.p.2">Some of the text in this document was taken from <a href="#RFC6336">[RFC6336]</a>, authored by Magnus Westerlund and Colin Perkins.  </p>
<p id="rfc.section.12.p.3">Thanks to Thomas Stach for the text in <a href="#sec-answer-subsequent">Section 4.2.3</a> and Roman Shpount for suggesting RTCP candidate handling in <a href="#sec-encoding">Section 4.1.1.2</a></p>
<p id="rfc.section.12.p.4">Thanks to following experts for their review and constructive feedback: Christer Holmberg.  </p>
<h1 id="rfc.references"><a href="#rfc.references">13.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">13.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="ICE-BIS">[ICE-BIS]</b>
      </td>
      <td class="top"><a>Keranen, A.</a> and <a>J. Rosenberg</a>, "<a href="http://tools.ietf.org/html/draft-ietf-ice-rfc5245bis-00">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", Internet-Draft draft-ietf-ice-rfc5245bis-00, March 2015.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3261">[RFC3261]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Schulzrinne, H.</a>, <a>Camarillo, G.</a>, <a>Johnston, A.</a>, <a>Peterson, J.</a>, <a>Sparks, R.</a>, <a>Handley, M.</a> and <a>E. Schooler</a>, "<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>", RFC 3261, DOI 10.17487/RFC3261, June 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3262">[RFC3262]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a> and <a>H. Schulzrinne</a>, "<a href="http://tools.ietf.org/html/rfc3262">Reliability of Provisional Responses in Session Initiation Protocol (SIP)</a>", RFC 3262, DOI 10.17487/RFC3262, June 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3264">[RFC3264]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a> and <a>H. Schulzrinne</a>, "<a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with Session Description Protocol (SDP)</a>", RFC 3264, DOI 10.17487/RFC3264, June 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3312">[RFC3312]</b>
      </td>
      <td class="top"><a>Camarillo, G.</a>, <a>Marshall, W.</a> and <a>J. Rosenberg</a>, "<a href="http://tools.ietf.org/html/rfc3312">Integration of Resource Management and Session Initiation Protocol (SIP)</a>", RFC 3312, DOI 10.17487/RFC3312, October 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3556">[RFC3556]</b>
      </td>
      <td class="top"><a>Casner, S.</a>, "<a href="http://tools.ietf.org/html/rfc3556">Session Description Protocol (SDP) Bandwidth Modifiers for RTP Control Protocol (RTCP) Bandwidth</a>", RFC 3556, DOI 10.17487/RFC3556, July 2003.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3605">[RFC3605]</b>
      </td>
      <td class="top"><a>Huitema, C.</a>, "<a href="http://tools.ietf.org/html/rfc3605">Real Time Control Protocol (RTCP) attribute in Session Description Protocol (SDP)</a>", RFC 3605, DOI 10.17487/RFC3605, October 2003.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4032">[RFC4032]</b>
      </td>
      <td class="top"><a>Camarillo, G.</a> and <a>P. Kyzivat</a>, "<a href="http://tools.ietf.org/html/rfc4032">Update to the Session Initiation Protocol (SIP) Preconditions Framework</a>", RFC 4032, DOI 10.17487/RFC4032, March 2005.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4566">[RFC4566]</b>
      </td>
      <td class="top"><a>Handley, M.</a>, <a>Jacobson, V.</a> and <a>C. Perkins</a>, "<a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a>", RFC 4566, DOI 10.17487/RFC4566, July 2006.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5226">[RFC5226]</b>
      </td>
      <td class="top"><a>Narten, T.</a> and <a>H. Alvestrand</a>, "<a href="http://tools.ietf.org/html/rfc5226">Guidelines for Writing an IANA Considerations Section in RFCs</a>", BCP 26, RFC 5226, DOI 10.17487/RFC5226, May 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5234">[RFC5234]</b>
      </td>
      <td class="top"><a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, DOI 10.17487/RFC5234, January 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5245">[RFC5245]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", RFC 5245, DOI 10.17487/RFC5245, April 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5389">[RFC5389]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>", RFC 5389, DOI 10.17487/RFC5389, October 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5768">[RFC5768]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5768">Indicating Support for Interactive Connectivity Establishment (ICE) in the Session Initiation Protocol (SIP)</a>", RFC 5768, DOI 10.17487/RFC5768, April 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6336">[RFC6336]</b>
      </td>
      <td class="top"><a>Westerlund, M.</a> and <a>C. Perkins</a>, "<a href="http://tools.ietf.org/html/rfc6336">IANA Registry for Interactive Connectivity Establishment (ICE) Options</a>", RFC 6336, April 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6679">[RFC6679]</b>
      </td>
      <td class="top"><a>Westerlund, M.</a>, <a>Johansson, I.</a>, <a>Perkins, C.</a>, <a>O'Hanlon, P.</a> and <a>K. Carlberg</a>, "<a href="http://tools.ietf.org/html/rfc6679">Explicit Congestion Notification (ECN) for RTP over UDP</a>", RFC 6679, DOI 10.17487/RFC6679, August 2012.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7092">[RFC7092]</b>
      </td>
      <td class="top"><a>Kaplan, H.</a> and <a>V. Pascual</a>, "<a href="http://tools.ietf.org/html/rfc7092">A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents</a>", RFC 7092, DOI 10.17487/RFC7092, December 2013.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7656">[RFC7656]</b>
      </td>
      <td class="top"><a>Lennox, J.</a>, <a>Gross, K.</a>, <a>Nandakumar, S.</a>, <a>Salgueiro, G.</a> and <a>B. Burman</a>, "<a href="http://tools.ietf.org/html/rfc7656">A Taxonomy of Semantics and Mechanisms for Real-Time Transport Protocol (RTP) Sources</a>", RFC 7656, DOI 10.17487/RFC7656, November 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">13.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC3725">[RFC3725]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Peterson, J.</a>, <a>Schulzrinne, H.</a> and <a>G. Camarillo</a>, "<a href="http://tools.ietf.org/html/rfc3725">Best Current Practices for Third Party Call Control (3pcc) in the Session Initiation Protocol (SIP)</a>", BCP 85, RFC 3725, DOI 10.17487/RFC3725, April 2004.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3960">[RFC3960]</b>
      </td>
      <td class="top"><a>Camarillo, G.</a> and <a>H. Schulzrinne</a>, "<a href="http://tools.ietf.org/html/rfc3960">Early Media and Ringing Tone Generation in the Session Initiation Protocol (SIP)</a>", RFC 3960, DOI 10.17487/RFC3960, December 2004.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4340">[RFC4340]</b>
      </td>
      <td class="top"><a>Kohler, E.</a>, <a>Handley, M.</a> and <a>S. Floyd</a>, "<a href="http://tools.ietf.org/html/rfc4340">Datagram Congestion Control Protocol (DCCP)</a>", RFC 4340, DOI 10.17487/RFC4340, March 2006.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5626">[RFC5626]</b>
      </td>
      <td class="top"><a>Jennings, C.</a>, <a>Mahy, R.</a> and <a>F. Audet</a>, "<a href="http://tools.ietf.org/html/rfc5626">Managing Client-Initiated Connections in the Session Initiation Protocol (SIP)</a>", RFC 5626, DOI 10.17487/RFC5626, October 2009.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5898">[RFC5898]</b>
      </td>
      <td class="top"><a>Andreasen, F.</a>, <a>Camarillo, G.</a>, <a>Oran, D.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5898">Connectivity Preconditions for Session Description Protocol (SDP) Media Streams</a>", RFC 5898, DOI 10.17487/RFC5898, July 2010.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.appendix.A"><a href="#rfc.appendix.A">Appendix A.</a> <a href="#sec-example" id="sec-example">Examples</a></h1>
<p id="rfc.section.A.p.1">For the example shown in section 12 of <a href="#ICE-BIS">[ICE-BIS]</a> the resulting offer (message 5) encoded in SDP looks like: </p>
<pre>
v=0
o=jdoe 2890844526 2890842807 IN IP6 $L-PRIV-1.IP
s=
c=IN IP6 $NAT-PUB-1.IP
t=0 0
a=ice-pwd:asd88fgpdd777uzjYhagZg
a=ice-ufrag:8hhY
m=audio $NAT-PUB-1.PORT RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 UDP 2130706431 $L-PRIV-1.IP $L-PRIV-1.PORT typ host
a=candidate:2 1 UDP 1694498815 $NAT-PUB-1.IP $NAT-PUB-1.PORT typ
 srflx raddr $L-PRIV-1.IP rport $L-PRIV-1.PORT
</pre>
<p id="rfc.section.A.p.2">The offer, with the variables replaced with their values, will look like (lines folded for clarity): </p>
<pre>
v=0
o=jdoe 2890844526 2890842807 IN IP6 fe80::6676:baff:fe9c:ee4a
s=
c=IN IP6 2001:420:c0e0:1005::61
t=0 0
a=ice-pwd:asd88fgpdd777uzjYhagZg
a=ice-ufrag:8hhY
m=audio 45664 RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 UDP 2130706431 fe80::6676:baff:fe9c:ee4a 8998 typ host
a=candidate:2 1 UDP 1694498815 2001:420:c0e0:1005::61 45664 typ srflx raddr
 fe80::6676:baff:fe9c:ee4a rport 8998
</pre>
<p id="rfc.section.A.p.3">The resulting answer looks like: </p>
<pre>
v=0
o=bob 2808844564 2808844564 IN IP4 $R-PUB-1.IP
s=
c=IN IP4 $R-PUB-1.IP
t=0 0
a=ice-pwd:YH75Fviy6338Vbrhrlp8Yh
a=ice-ufrag:9uB6
m=audio $R-PUB-1.PORT RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 UDP 2130706431 $R-PUB-1.IP $R-PUB-1.PORT typ host
</pre>
<p id="rfc.section.A.p.4">With the variables filled in: </p>
<pre>
v=0
o=bob 2808844564 2808844564 IN IP4 192.0.2.1
s=
c=IN IP4 192.0.2.1
t=0 0
a=ice-pwd:YH75Fviy6338Vbrhrlp8Yh
a=ice-ufrag:9uB6
m=audio 3478 RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 UDP 2130706431 192.0.2.1 3478 typ host
</pre>
<h1 id="rfc.appendix.B"><a href="#rfc.appendix.B">Appendix B.</a> <a href="#sec-why-remote" id="sec-why-remote">The remote-candidates Attribute</a></h1>
<p id="rfc.section.B.p.1">The a=remote-candidates attribute exists to eliminate a race condition between the updated offer and the response to the STUN Binding request that moved a candidate into the Valid list.  This race condition is shown in <a href="#fig-race-flow">Figure 1</a>.  On receipt of message 4, agent L adds a candidate pair to the valid list.  If there was only a single media stream with a single component, agent L could now send an updated offer.  However, the check from agent R has not yet generated a response, and agent R receives the updated offer (message 7) before getting the response (message 9).  Thus, it does not yet know that this particular pair is valid.  To eliminate this condition, the actual candidates at R that were selected by the offerer (the remote candidates) are included in the offer itself, and the answerer delays its answer until those pairs validate.  </p>
<div id="rfc.figure.1"/>
<div id="fig-race-flow"/>
<pre>
Agent L               Network               Agent R
   |(1) Offer            |                     |
   |------------------------------------------&gt;|
   |(2) Answer           |                     |
   |&lt;------------------------------------------|
   |(3) STUN Req.        |                     |
   |------------------------------------------&gt;|
   |(4) STUN Res.        |                     |
   |&lt;------------------------------------------|
   |(5) STUN Req.        |                     |
   |&lt;------------------------------------------|
   |(6) STUN Res.        |                     |
   |--------------------&gt;|                     |
   |                     |Lost                 |
   |(7) Offer            |                     |
   |------------------------------------------&gt;|
   |(8) STUN Req.        |                     |
   |&lt;------------------------------------------|
   |(9) STUN Res.        |                     |
   |------------------------------------------&gt;|
   |(10) Answer          |                     |
   |&lt;------------------------------------------|
</pre>
<p class="figure">Figure 1: Race Condition Flow</p>
<h1 id="rfc.appendix.C"><a href="#rfc.appendix.C">Appendix C.</a> <a href="#sec-glare" id="sec-glare">Why Is the Conflict Resolution Mechanism Needed?</a></h1>
<p id="rfc.section.C.p.1">When ICE runs between two peers, one agent acts as controlled, and the other as controlling.  Rules are defined as a function of implementation type and offerer/answerer to determine who is controlling and who is controlled.  However, the specification mentions that, in some cases, both sides might believe they are controlling, or both sides might believe they are controlled.  How can this happen? </p>
<p id="rfc.section.C.p.2">The condition when both agents believe they are controlled shows up in third party call control cases.  Consider the following flow: </p>
<div id="rfc.figure.2"/>
<div id="fig-conflict"/>
<pre>
          A         Controller          B
          |(1) INV()     |              |
          |&lt;-------------|              |
          |(2) 200(SDP1) |              |
          |-------------&gt;|              |
          |              |(3) INV()     |
          |              |-------------&gt;|
          |              |(4) 200(SDP2) |
          |              |&lt;-------------|
          |(5) ACK(SDP2) |              |
          |&lt;-------------|              |
          |              |(6) ACK(SDP1) |
          |              |-------------&gt;|
</pre>
<p class="figure">Figure 2: Role Conflict Flow</p>
<p id="rfc.section.C.p.3">This flow is a variation on flow III of RFC 3725 <a href="#RFC3725">[RFC3725]</a>.  In fact, it works better than flow III since it produces fewer messages.  In this flow, the controller sends an offerless INVITE to agent A, which responds with its offer, SDP1.  The agent then sends an offerless INVITE to agent B, which it responds to with its offer, SDP2.  The controller then uses the offer from each agent to generate the answers.  When this flow is used, ICE will run between agents A and B, but both will believe they are in the controlling role.  With the role conflict resolution procedures, this flow will function properly when ICE is used.  </p>
<p id="rfc.section.C.p.4">At this time, there are no documented flows that can result in the case where both agents believe they are controlled.  However, the conflict resolution procedures allow for this case, should a flow arise that would fit into this category.  </p>
<h1 id="rfc.appendix.D"><a href="#rfc.appendix.D">Appendix D.</a> Why Send an Updated Offer?</h1>
<p id="rfc.section.D.p.1">Section 11.1 describes rules for sending media.  Both agents can send media once ICE checks complete, without waiting for an updated offer.  Indeed, the only purpose of the updated offer is to "correct" the SDP so that the default destination for media matches where media is being sent based on ICE procedures (which will be the highest-priority nominated candidate pair).  </p>
<p id="rfc.section.D.p.2">This begs the question&#8201;&#8212;&#8201;why is the updated offer/answer exchange needed at all? Indeed, in a pure offer/answer environment, it would not be.  The offerer and answerer will agree on the candidates to use through ICE, and then can begin using them.  As far as the agents themselves are concerned, the updated offer/answer provides no new information.  However, in practice, numerous components along the signaling path look at the SDP information.  These include entities performing off-path QoS reservations, NAT traversal components such as ALGs and Session Border Controllers (SBCs), and diagnostic tools that passively monitor the network.  For these tools to continue to function without change, the core property of SDP&#8201;&#8212;&#8201;that the existing, pre-ICE definitions of the addresses used for media&#8201;&#8212;&#8201;the "m=" and "c=" lines and the rtcp attribute&#8201;&#8212;&#8201;must be retained.  For this reason, an updated offer must be sent.  </p>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Marc Petit-Huguenin</span> 
	  <span class="n hidden">
		<span class="family-name">Petit-Huguenin</span>
	  </span>
	</span>
	<span class="org vcardline">Impedance Mismatch</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:marc@petit-huguenin.org">marc@petit-huguenin.org</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ari Keranen</span> 
	  <span class="n hidden">
		<span class="family-name">Keranen</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Jorvas</span>,  
		<span class="region"></span>
		<span class="code">02420</span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ari.keranen@ericsson.com">ari.keranen@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Suhas Nandakumar</span> 
	  <span class="n hidden">
		<span class="family-name">Nandakumar</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span class="vcardline">707 Tasman Dr</span>

	  <span class="vcardline">
		<span class="locality">Milpitas</span>,  
		<span class="region">CA</span> 
		<span class="code">95035</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:snandaku@cisco.com">snandaku@cisco.com</a></span>

  </address>
</div>

</body>
</html>
